;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#
;
;	Module		:SYSTEM_BATTLE_DAMAGE.ERB
;	Facility	:戦闘システム（ダメージ計算処理）
;
;	Licence		:ライセンスフリー。
;
;	Modification Data:
;
;	Edit	Date			Author					Reason
;	001		20XX/XX/XX		----					新規作成
;	002		2011/11/09		旅人					統合整備
;													ファイルが肥大化している為、ダメージ処理を分離
;			2011/11/11		旅人					統合整備（ダメージ計算処理統合）
;	003		2013/04/13		銃Ｐ					煌天の会心が機能しないのを修正
;	004		2016/12/09		Jガン					自身の素質によってダメージアップするように
;	005		2016/12/11		Jガン					1moreフラグを少し変更
;	006		2017/09/27		Jガン					幸福時にダメージに効果があるように
;	006		2017/10/30		Jガン					独覚時に弱点を吸収するように
;	006		2017/10/30		Jガン					スキル吸収関数作成のための編集
;	007		2018/06/06		JK好き					サードアイに被与クリティカル率アップ効果を追加
;	008		2018/09/02		千鶴					各種ブースタスキルの処理の追加
;	009		2019/11/27		Jガン					クリティカル無効フラグ追加
;	010		2019/12/30		Jガン					カウンター追加による回避失敗等の追加
;	011		2020/02/20		Jガン					FLY仕様変更による倍率変更
;	012		2020/03/XX		Jガン					武器素質仕様の変更、追加
;	013		2020/07/05		Jガン					ダメージ計算の変更、与ダメージ補正、属性ダメージ補正、隠れ耐性等追加
;	014		2020/07/31		Jガン					1more処理を整理して一つに(1moreオプション仕様は前と一緒)、クリティカル処理を縦長に見やすく
;													ONE_MORE_POINT_ADD関数追加、銃攻撃には切り落としㆍ気合は影響しないように
;	015		2020/07/31		kamedakeisuke(ﾟдﾟ)		クライマックスレヴューに関する記述を追加
;	016		2020/08/22		名無し					ガードキルと貫通の相互作用を調整
;	017		2020/08/28		Jガン					父の名を別の効果に(貫通付きに)、デビルトリガーによるダメージアップ追加
;	018		2020/09/02		Jガン					バージルのスキルの処理追加
;	019		2020/09/07		Jガン					デビルトリガー、クライマックスレビューの処理が正しく機能してないのを修正
;	020		2020/09/17		SUIHOU					エアハイクの被クリティカル率減少補正を追加
;	021		2020/10/23		Jガン					クリティカル補正が正しく計算されるように
;	022		2021/01/29		Rsp暇人					道具命中/道具威力を新設
;	023		2021/03/21		木綿豆腐				SONG OF DIVAに関する処理を追加
;	024		2021/05/01		Jガン					貫通フラグの処理を変更(ダメージタイプと相性で指定できるように)、割合攻撃処理をここに移動
;	025		2021/04/24		SUIHOU					FATE_鯖共通専用技の効果を追記
;	026		2021/05/17		しゃけ					災厄の巨焔、ラグナロク（ＡＮ）の処理追加
;	027		2021/05/24		Jガン					HP処理を簡略化
;	028		2021/06/10		Schrott					アナーキーバレットヘルに対し、摩多羅神以外が所持していると機能しない様に。
;	029		2021/06/24		しゃけ					謎のヒロインX'sの処理を追加,CRT_CHECKを追加
;	030		2021/08/11		木綿豆腐				SONG OF DIVAに関する処理のミスを修正
;	031		2021/08/19		SUIHOU					FATE鯖専用スキルの効果を各種追記ㆍ修正
;	032		2021/11/23		kamedakeisuke(ﾟдﾟ)		他人気合フラグ、他人集中フラグの処理を追加
;	033		2022/02/04		しゃけ					デンゲキコの処理を追加
;	034		2022/04/14		takaya					魔人学園キャラの処理を追加
;	035		2022/05/30		takaya					クリティカル率のミスを修正及び与クリ減少と被クリ増加の自動効果追加
;	036		2022/05/29		takaya					アンリマユのスキル処理を追加
;	037		2022/07/11		沖田					沖田のスキル処理を追加
;	038		2022/04/20		しゃけ					アーミヤ専用技の効果を追加、BTL_CALC_DAMAGE_ADJUSTMENTの無効化処理部分を改良
;	039		2022/08/05		NEO						種族特効スキル関連処理の追加
;	040		2022/08/02		Schrott					会心率強化フラグ、会心確定フラグ、会心専心の処理を創設、切り落としフラグから必殺率上昇措置を分離。各種ダメージ補正を味方にも適用。
;
;	KR_01	2023/05/12		Moscode					한글판 개조 XCOM2 스킬 추가
;_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/#

;===============================================================================
;  ◇記載関数一覧(記載順)
;
;		Module Name						Explanation
;
;	ㆍ DAMAGE_1							BTL計算:ダメージ(物理)
;	ㆍ DAMAGE_2							BTL計算:ダメージ(魔法)
;;	ㆍ ダメージ試算						
;;	ㆍ ダメージ試算_1					
;;	ㆍ ダメージ試算_2					
;	ㆍ BTL_CHK_リンケージ				BTL:リンケージチェック
;	ㆍ BTL_CHK_SKILL_貫通				BTL:スキルチェック(貫通)
;	ㆍ BTL_CALC_DAMAGE_BLOCK			BTL計算:ダメージブロック
;	ㆍ BTL_CALC_BASE_DAMAGE				BTL計算:基礎ダメージ
;	ㆍ BTL_CALC_DAMAGE_ADJUSTMENT		BTL計算:ダメージ調整
;	ㆍ BTL_CALC_DAMAGE_EXE				BTL計算:ダメージ実行
;	ㆍ BTL_CALC_DAMAGE_COOP				BTL計算:COOP
;
;===============================================================================

;=================================================
;   sub DAMAGE_1
;=================================================
;   BTL計算:ダメージ(物理)
;-------------------------------------------------
;   基本的な物理攻撃のダメージ処理
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:2				威力
;  ARG:3				攻撃相性
;  ARG:4				クリティカル率(%)
;  ARG:5				吸収率
;-------------------------------------------------
@DAMAGE_1,ARG,ARG:1,ARG:2,ARG:3,ARG:4 = 5,ARG:5 = 0
;---- EDIT 002 DEL START ---------------------------
;#DIM ＣＯＯＰ回数 , 1
;---- EDIT 002 DEL END   ---------------------------
;LOCAL ダメージ
;LOCAL:1　1moreとCO-OPのフラグていうかクリフラグ
LOCAL:1 = 0;more系

CALL RECEIVE_SET,ARG:1,ARG:3,1
SIF !FLAG:카운터중
	CFLAG:(ARG:1):회피실패 = 1
;---- EDIT 002 DEL START ---------------------------
;;リンケージの場合、能力参照者を指定できる
;IF CFLAG:ARG:링케이지발동 && !CFLAG:ARG:단독링케이지
;	TRYCCALLFORM リンケージ能力参照者_{CFLAG:ARG:사용링케이지}, ARG
;		TRYCALLFORM リンケージ能力参照者_{CFLAG:ARG:사용링케이지}, ARG
;		SIF RESULT
;			ARG = CFLAG:ARG:@"リンケージ参加者{RESULT}"
;	CATCH
;	ENDCATCH
;ENDIF
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
;- BTL:リンケージチェック
CALL BTL_CHK_링케이지(ARG)
ARG = RESULT
;---- EDIT 002 ADD END   ---------------------------

;---- EDIT 002 DEL START ---------------------------
;IF (!CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && ((MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 0 && HAVE_SKILL(ARG,2420) == 0 && HAVE_SKILL(ARG,2421) == 0) || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999)) || (CFLAG:(ARG:1):물리반사플래그 && ARG:3 < 4) || (CFLAG:(ARG:1):마법반사플래그 && (ARG:3 > 3 && ARG:3 != 17)) || CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ウェイト") == 2
;	PRINT BLOCK
;	RETURN 0
;ENDIF
;---- EDIT 002 DEL END   ---------------------------

;---- EDIT 002 ADD START ---------------------------
;- BTL計算:ダメージブロック (1:物理)
IF (BTL_CALC_DAMAGE_BLOCK(ARG:0, ARG:1, ARG:3, 1) )
	CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, 0, 1
	PRINT BLOCK
	RETURN 0
ENDIF
;---- EDIT 002 ADD END   ---------------------------

;---- EDIT 002 DEL START ---------------------------
;LOCAL:10 = ARG:5
;
;LOCAL = (100+MAXBASE:ARG:LV)*(ARG:2)*(MAXBASE:ARG:공격)*(10+MAXBASE:ARG:공격/12)
;LOCAL /= (MAXBASE:(ARG:1):방어)*100*100
;;LOCAL = POWER(MAX(1,MAXBASE:ARG:(GET_BATTLESTATUS(0)) + (ARG:2 - 100)/5),2) / MAXBASE:(ARG:1):(GET_BATTLESTATUS(2))
;
;;乱数
;SIF LOCAL > 0
;	LOCAL += RAND:3
;LOCAL *= (9500+RAND:1000)
;LOCAL /= 10000
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
;- BTL計算:基礎ダメージ
CALL BTL_CALC_BASE_DAMAGE(ARG:0, ARG:1, ARG:2, "물리")
LOCAL = RESULT
;---- EDIT 002 ADD END   ---------------------------

SIF GET_STATE(CFLAG:ARG:상태이상) == "POISON"
	LOCAL /= 2
;---- EDIT 002 DEL START ---------------------------
;LOCAL *= (32 + CFLAG:ARG:공격강화)
;LOCAL /= (32 + CFLAG:(ARG:1):방어강화)
;SIF CFLAG:ARG:기합플래그
;	TIMES LOCAL , 2.5
;	;LOCALS = %GET_TYPE(ARG:3)%無効化回数
;	;ドレイン状態
;	IF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ウェイト") == 3 
;		LOCAL *= -50
;	ELSEIF (HAVE_SKILL(ARG,[[스킬:관통]]) || HAVE_SKILL(ARG,[[스킬:영세라이도우]])) && RANGE(MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) , 0 , 99)
;		;貫通持ちは耐性と無効を無視
;		LOCAL *= MAX(100,MAXBASE:(ARG:1):(GET_TYPE(ARG:3)))
;		;ベルㆍデルは貫通でも0ダメージに
;		SIF NO:(ARG:1) == [[캐릭터:벨ㆍ데르]]
;			LOCAL = 0
;	ELSEIF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) < 100 || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999)
;		;ガードキル効果：耐性以上を完全に無視
;		LOCAL *= 100
;		;LOCAL *= MAX(100,MAXBASE:(ARG:1):(GET_TYPE(ARG:3)))
;		;ベルㆍデルは貫通でも0ダメージに
;		SIF NO:(ARG:1) == [[캐릭터:벨ㆍ데르]]
;			LOCAL = 0
;	ELSE
;		LOCAL *= MAXBASE:(ARG:1):(GET_TYPE(ARG:3))
;	ENDIF
;	LOCAL /= 100
;	IF HAVE_SKILL(ARG,[[스킬:영세라이도우]]) == 0
;		IF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "無効化回数")
;			LOCAL = 0
;			CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "被弾") = 1
;		ENDIF
;		;◯◯ブレイク
;		SIF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ウェイト") == 1
;			LOCAL = 0
;	ENDIF
;	;後列のキャラにはダメージ減少
;	SIF (CFLAG:(ARG:1):포지션 > 3 && CFLAG:(ARG:1):포지션 < 7) || CFLAG:(ARG:1):포지션 > 11
;		TIMES LOCAL,0.70
;	;防御中のキャラにはダメージ減少
;	SIF CFLAG:(ARG:1):방어플래그
;		LOCAL /= 2
;	IF CFLAG:(ARG:1):PT플래그 > 0
;		SELECTCASE FLAG:전투난이도
;			CASE 1
;				TIMES LOCAL,0.75
;			CASE 3,4
;				TIMES LOCAL , 1.5
;			CASE 5
;				TIMES LOCAL , 2
;			CASE 6
;				TIMES LOCAL , 3
;		ENDSELECT
;	ENDIF
;	SIF CFLAG:(ARG:1):PT플래그 == 0 && FLAG:전투난이도 == 1
;		TIMES LOCAL , 1.40
;	;眠っていたらダメージ大
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SLEEP")
;		TIMES LOCAL,1.5
;	;自身がオルギアでダメージ上昇
;	SIF CFLAG:ARG:상태이상 == GET_STATE_NUM("ORGY")
;		TIMES LOCAL,1.25
;	;FREEZE時は電撃、SHOCK時は氷結のダメージが倍化
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("FREEZE") && GET_TYPE(ARG:3) == "電撃" || CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SHOCK") && GET_TYPE(ARG:3) == "氷結"
;		TIMES LOCAL,2.0
;	;追撃の心得持ち+1more中は威力が1.5倍
;	SIF CFLAG:ARG:１more플래그 > 0 && HAVE_SKILL(ARG,[[스킬:추격의심득]])
;		TIMES LOCAL,1.5 
;	;真ㆍ全門耐性(万能以外半減ㆍ万能倍化)
;	SIF HAVE_SKILL(ARG:1, [[스킬:진ㆍ전문내성]])
;		LOCAL = ARG:3 == 17 ? LOCAL * 2 # LOCAL / 2
;	;特殊ダメージ補正
;	LOCAL = LOCAL * (CFLAG:(ARG:1):물리피데미지보정 +100) / 100
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
	;- BTL計算:ダメージ調整 (1:物理)
	CALL BTL_CALC_DAMAGE_ADJUSTMENT(ARG:0, ARG:1, LOCAL, ARG:3, 1)
	LOCAL = RESULT
;---- EDIT 002 ADD END   ---------------------------

;---- EDIT 002 DEL START -------------------------
;	;クリティカル判定
;	IF RAND:100 < ARG:4 * (10 + MAXBASE:ARG:운) / (10 + MAXBASE:(ARG:1):운)*(CFLAG:(ARG):크리티컬강화+8)/((HAVE_SKILL(ARG:1,2418) > 0)+1)*((HAVE_SKILL(ARG,2419)>0)+2)/8 * (CFLAG:ARG:베어내기플래그*20+CFLAG:ARG:크리티컬보정+100) / 100
;		TIMES LOCAL , 1.50
;		PRINTFORM 《CRITICAL》 
;		LOCAL:1 += 2
;	ELSEIF HAVE_SKILL(ARG,[[스킬:황천의회심]]) && FLAG:월령 == 8 || HAVE_SKILL(ARG,[[스킬:정천의회심]]) && FLAG:월령 == 0
;		TIMES LOCAL , 1.50
;		PRINTFORM 《CRITICAL》 
;		LOCAL:1 += 2
;	ELSE
;		SELECTCASE GET_STATE(CFLAG:(ARG:1):상태이상)
;			CASE "SLEEP","SHOCK","FREEZE"
;				TIMES LOCAL , 1.50
;				PRINTFORM 《CRITICAL》 
;				LOCAL:1 += 2
;		ENDSELECT
;	ENDIF
;	;とりあえず1.2倍しといてみる
;	IF LOCAL >= BASE:(ARG:1):ＨＰ && (HAVE_SKILL(ARG:1,2407) || (EQUIP:(ARG:1):바ㆍ벨 && FLAG:벨신격파 & 8)) && CFLAG:(ARG:1):이악물기플래그 == 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,2
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF  LOCAL >= BASE:(ARG:1):ＨＰ && HAVE_SKILL(ARG:1,[[스킬:네버기브업]]) && CFLAG:(ARG:1):이악물기플래그 == 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,5
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF  LOCAL >= BASE:(ARG:1):ＨＰ && HAVE_SKILL(ARG:1,2406) && CFLAG:(ARG:1):이악물기플래그 == 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,1
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF  LOCAL >= BASE:(ARG:1):ＨＰ && HAVE_SKILL(ARG:1,2434)
;		;アルカナシフトを持ってる限り食いしばります。
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,4
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF LOCAL >= 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,0
;	ELSE
;		PRINTFORM {-LOCAL}回復
;		CALL VAR_HP,ARG:1,-LOCAL,3
;		;わざわざスナッピーの為に何をしているんだ俺は
;		CFLAG:(ARG:1):데미지흡수량 -= LOCAL
;	ENDIF
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SLEEP")
;		CFLAG:(ARG:1):상태이상 = 0
;---- EDIT 002 DEL END ---------------------------
;---- EDIT 002 ADD START -------------------------

	;- BTL計算:ダメージ実行 (1:物理)
	CALL BTL_CALC_DAMAGE_EXE(ARG:0, ARG:1, LOCAL, ARG:3, 1, ARG:4,ARG:5)
	LOCAL	= RESULT:0
	LOCAL:1	= RESULT:1

;---- EDIT 002 ADD END ---------------------------
	CALL RECEIVE_SET,ARG:1,ARG:3,1,LOCAL,LOCAL:1


	;口上用にフラグ保存
	CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, LOCAL, 1
	
	SIF LOCAL < 1
		RETURN 0

;---- EDIT 002 DEL START -------------------------
;	;COOP or 1moreのフラグ立て
;	SIF MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) > 100 && MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) != 999
;		LOCAL:1 += 1
;	;弱点を付かれ、防御しておらず、ダメージを受けており、瀕死になっていなければＣＯＯＰの対象に
;	;行動者が敵なら、
;	IF CFLAG:(ARG:1):상태이상 != GET_STATE_NUM("DYING") && LOCAL > 0 && CFLAG:(ARG:1):방어플래그 == 0 && LOCAL:1
;		IF CFLAG:ARG:PT플래그 > 0
;			SIF LOCAL:1 & 1
;				CFLAG:(ARG:1):ＣＯＯＰ플래그 += ARG:2
;			SIF LOCAL:1 & 2
;				CFLAG:(ARG:1):ＣＯＯＰ플래그 += ARG:2/2
;		ELSEIF CFLAG:ARG:PT플래그 != CFLAG:(ARG:1):PT플래그 && CFLAG:ARG:１more플래그 == 0
;			CFLAG:ARG:１more플래그 = 1
;		ENDIF
;	ENDIF
;---- EDIT 002 DEL END ---------------------------
;---- EDIT 002 ADD START -------------------------

	;- BTL計算:COOP (1:物理)
	SIF !FLAG:카운터중
		CALL BTL_CALC_DAMAGE_COOP(ARG:0, ARG:1, LOCAL, ARG:3, 1, LOCAL:1, ARG:2)

;---- EDIT 002 ADD END ---------------------------
	;ダメージを受け、死亡しており、ハントスキルを使われていた場合は被ハントフラグを立てておく
	IF LOCAL > 0 && CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("DYING")
		TRYCCALLFORM 헌트스킬_{CFLAG:ARG:입력행동}
			CFLAG:(ARG:1):피헌트 = ARG + 1
		CATCH
		ENDCATCH
	ENDIF
	RETURN 1

;=================================================
;   sub DAMAGE_2
;=================================================
;   BTL計算:ダメージ(魔法)
;-------------------------------------------------
;   基本的な魔法攻撃のダメージ処理
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:2				威力
;  ARG:3				攻撃相性
;  ARG:4				クリティカル率(%)
;  ARG:5				吸収率
;-------------------------------------------------
@DAMAGE_2,ARG,ARG:1,ARG:2,ARG:3,ARG:4 = 5,ARG:5 = 0
;LOCAL ダメージ
;LOCAL:1　1moreとCO-OPのフラグていうかクリフラグ
LOCAL:1 = 0;more系

;---- EDIT 002 DEL START ---------------------------
;;リンケージの場合、能力参照者を指定できる
;IF CFLAG:ARG:링케이지발동 && !CFLAG:ARG:단독링케이지
;	;PRINTFORMW %CALLNAME:ARG%の攻撃力は{MAXBASE:ARG:마법위력}
;	TRYCCALLFORM リンケージ能力参照者_{CFLAG:ARG:사용링케이지}, ARG
;		TRYCALLFORM リンケージ能力参照者_{CFLAG:ARG:사용링케이지}, ARG
;		SIF RESULT
;			ARG = CFLAG:ARG:@"リンケージ参加者{RESULT}"
;	CATCH
;	ENDCATCH
;ENDIF
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
;- BTL:リンケージチェック
CALL BTL_CHK_링케이지(ARG)
ARG = RESULT
;---- EDIT 002 ADD END   ---------------------------
CALL RECEIVE_SET,ARG:1,ARG:3,2
SIF !FLAG:카운터중
	CFLAG:(ARG:1):회피실패 = 1

;---- EDIT 002 DEL START ---------------------------
;IF (!CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 0 || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999)) || (CFLAG:(ARG:1):물리반사플래그 && ARG:3 < 4) || (CFLAG:(ARG:1):마법반사플래그 && (ARG:3 > 3 && ARG:3 != 17)) || CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ウェイト") == 2
;	PRINT BLOCK
;	RETURN 0
;ENDIF
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
;- BTL計算:ダメージブロック (2:魔法)
IF (BTL_CALC_DAMAGE_BLOCK(ARG:0, ARG:1, ARG:3, 2) )
	CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, 0, 1
	PRINT BLOCK
	RETURN 0
ENDIF
;---- EDIT 002 ADD END   ---------------------------

;---- EDIT 002 DEL START ---------------------------
;;LOCAL = ((MAXBASE:ARG:(GET_BATTLESTATUS(4)) * 2 * (MAXBASE:ARG:(GET_BATTLESTATUS(4))/8+1))/16+MAXBASE:ARG:(GET_BATTLESTATUS(4))+8) * (ARG:2 + MAXBASE:ARG:(GET_BATTLESTATUS(4))/4+1) / (MAXBASE:(ARG:1):마법효과 + MAXBASE:(ARG:1):방어/2 + MAXBASE:(ARG:1):마법위력/4)
;;LOCAL = ((MAXBASE:ARG:(GET_BATTLESTATUS(4)) * 2 * (MAXBASE:ARG:(GET_BATTLESTATUS(4))*3/8+1))/16+MAXBASE:ARG:(GET_BATTLESTATUS(4))+8) * (ARG:2) / (MAXBASE:(ARG:1):마법효과 + MAXBASE:(ARG:1):방어/2 + MAXBASE:(ARG:1):마법위력/4)
;
;LOCAL = (100+MAXBASE:ARG:LV)*(ARG:2)*(MAXBASE:ARG:마법위력)*(10+MAXBASE:ARG:마법위력/12)
;LOCAL /= ((MAXBASE:(ARG:1):마법효과*2+MAXBASE:(ARG:1):방어)/3)*100*100
;;乱数
;SIF LOCAL > 0
;	LOCAL += RAND:3
;	LOCAL *= (9500+RAND:1000)
;	LOCAL /= 10000
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
;- BTL計算:基礎ダメージ
CALL BTL_CALC_BASE_DAMAGE(ARG:0, ARG:1, ARG:2, "마법")
LOCAL = RESULT
;---- EDIT 002 ADD END   ---------------------------

SIF GET_STATE(CFLAG:ARG:상태이상) == "CLOSE"
	LOCAL /= 5

;---- EDIT 002 DEL START ---------------------------
;LOCAL *= (32 + CFLAG:ARG:마법위력강화)
;LOCAL /= (32 + CFLAG:(ARG:1):방어강화)
;SIF CFLAG:ARG:집중플래그
;	TIMES LOCAL , 2.5
;	;LOCALS = %GET_TYPE(ARG:3)%無効化回数
;	;ドレイン状態
;	IF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ウェイト") == 3
;		LOCAL *= -50
;	ELSEIF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) < 100 || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999)
;		;ガードキル効果：耐性以上を完全に無視
;		LOCAL *= 100
;		;LOCAL *= MAX(100,MAXBASE:(ARG:1):(GET_TYPE(ARG:3)))
;		;ベルㆍデルは貫通でも0ダメージに
;		SIF NO:(ARG:1) == [[캐릭터:벨ㆍ데르]]
;			LOCAL = 0
;	ELSE
;		LOCAL *= MAXBASE:(ARG:1):(GET_TYPE(ARG:3))
;	ENDIF
;	LOCAL /= 100
;	IF HAVE_SKILL(ARG,[[스킬:영세라이도우]]) == 0
;		IF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "無効化回数")
;			LOCAL = 0
;			CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "被弾") = 1
;		ENDIF
;		;◯◯ブレイク
;		SIF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ウェイト") == 1
;			LOCAL = 0
;	ENDIF
;	;後列のキャラにはダメージ減少
;	SIF (CFLAG:(ARG:1):포지션 > 3 && CFLAG:(ARG:1):포지션 < 7) || CFLAG:(ARG:1):포지션 > 11
;		TIMES LOCAL,0.70
;	SIF CFLAG:(ARG:1):방어플래그
;		LOCAL /= 2
;	;難易度修正
;	IF CFLAG:(ARG:1):PT플래그 > 0
;		SELECTCASE FLAG:전투난이도
;			CASE 1
;				TIMES LOCAL,0.75
;			CASE 3,4
;				TIMES LOCAL , 1.5
;			CASE 5
;				TIMES LOCAL , 2
;			CASE 6
;				TIMES LOCAL , 3
;		ENDSELECT
;	ENDIF
;	SIF CFLAG:(ARG:1):PT플래그 == 0 && FLAG:전투난이도 == 1
;		TIMES LOCAL , 1.40
;	;眠っていたらダメージ大
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SLEEP")
;		TIMES LOCAL,1.5
;	;自身がオルギアでダメージ上昇
;	SIF CFLAG:ARG:상태이상 == GET_STATE_NUM("ORGY")
;		TIMES LOCAL,1.25
;	;FREEZE時は電撃、SHOCK時は氷結のダメージが倍化
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("FREEZE") && GET_TYPE(ARG:3) == "電撃" || CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SHOCK") && GET_TYPE(ARG:3) == "氷結"
;		TIMES LOCAL,2.0
;	;追撃の心得持ち+1more中は威力が1.5倍
;	SIF CFLAG:ARG:１more플래그 > 0 && HAVE_SKILL(ARG,[[스킬:추격의심득]])
;		TIMES LOCAL,1.5 
;	;真ㆍ全門耐性(万能以外半減ㆍ万能倍化)
;	SIF HAVE_SKILL(ARG:1, [[스킬:진ㆍ전문내성]])
;		LOCAL = ARG:3 == 17 ? LOCAL * 2 # LOCAL / 2
;	LOCAL = LOCAL * (CFLAG:(ARG:1):마법피데미지보정 +100) / 100
;---- EDIT 002 DEL END   ---------------------------
;---- EDIT 002 ADD START ---------------------------
	;- BTL計算:ダメージ調整 (2:魔法)
	CALL BTL_CALC_DAMAGE_ADJUSTMENT(ARG:0, ARG:1, LOCAL, ARG:3, 2)
	LOCAL = RESULT
;---- EDIT 002 ADD END   ---------------------------


;---- EDIT 002 DEL START -------------------------
;	;試験的にダメージを減らす
;	;TIMES LOCAL , 0.70
;	IF LOCAL >= BASE:(ARG:1):ＨＰ && (HAVE_SKILL(ARG:1,2407) || (EQUIP:(ARG:1):바ㆍ벨 && FLAG:벨신격파 & 8)) && CFLAG:(ARG:1):이악물기플래그 == 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,2
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF  LOCAL >= BASE:(ARG:1):ＨＰ && HAVE_SKILL(ARG:1,[[스킬:네버기브업]]) && CFLAG:(ARG:1):이악물기플래그 == 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,5
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF  LOCAL >= BASE:(ARG:1):ＨＰ && HAVE_SKILL(ARG:1,2406) && CFLAG:(ARG:1):이악물기플래그 == 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,1
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF  LOCAL >= BASE:(ARG:1):ＨＰ && HAVE_SKILL(ARG:1,2434)
;		;アルカナシフトを持ってる限り食いしばります。
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,4
;		CFLAG:(ARG:1):이악물기플래그 = 1
;	ELSEIF LOCAL >= 0
;		PRINTFORM {LOCAL}ダメージ
;		CALL VAR_HP,ARG:1,-LOCAL,0
;	ELSE
;		PRINTFORM {-LOCAL}回復
;		CALL VAR_HP,ARG:1,-LOCAL,3
;		;わざわざスナッピーの為に何をしているんだ俺は
;		CFLAG:(ARG:1):데미지흡수량 -= LOCAL
;	ENDIF
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SLEEP") && LOCAL > 0
;		CFLAG:(ARG:1):상태이상 = 0
;---- EDIT 002 DEL END ---------------------------
;---- EDIT 002 ADD START -------------------------

	;- BTL計算:ダメージ実行 (2:魔法)
	CALL BTL_CALC_DAMAGE_EXE(ARG:0, ARG:1, LOCAL, ARG:3, 2, ARG:4,ARG:5)
	LOCAL	= RESULT:0
	LOCAL:1	= RESULT:1

;---- EDIT 002 ADD END ---------------------------
CALL RECEIVE_SET,ARG:1,ARG:3,2,LOCAL,LOCAL:1

	;口上用にフラグ保存
	CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, LOCAL, 1
	
	SIF LOCAL < 1
		RETURN 0
;---- EDIT 002 DEL START -------------------------
;	;COOP or 1moreのフラグ立て
;	SIF MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) > 100 && MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) != 999
;		LOCAL:1 += 1
;	;弱点を付かれ、防御しておらず、ダメージを受けており、瀕死になっていなければＣＯＯＰの対象に
;	;行動者が敵なら、
;	IF CFLAG:(ARG:1):상태이상 != GET_STATE_NUM("DYING") && LOCAL > 0 && CFLAG:(ARG:1):방어플래그 == 0 && LOCAL:1 == 1
;		IF CFLAG:ARG:PT플래그 > 0
;			CFLAG:(ARG:1):ＣＯＯＰ플래그 += ARG:2
;		ELSEIF CFLAG:ARG:PT플래그 != CFLAG:(ARG:1):PT플래그 && CFLAG:ARG:１more플래그 == 0
;			CFLAG:ARG:１more플래그 = 1
;		ENDIF
;	ENDIF
;---- EDIT 002 DEL END ---------------------------
;---- EDIT 002 ADD START -------------------------

	;- BTL計算:COOP (2:魔法)
	SIF !FLAG:카운터중
		CALL BTL_CALC_DAMAGE_COOP(ARG:0, ARG:1, LOCAL, ARG:3, 2, LOCAL:1, ARG:2)

;---- EDIT 002 ADD END ---------------------------



RETURN 1

;---- EDIT 002 DEL START --------------------------- 使用されるまでコメントアウト
;
;@ダメージ試算,ARG,ARG:1,ARG:2
;CALLFORM SKILL_DAMAGETYPE_{ARG:2}
;CALLFORM ダメージ試算_{RESULT},ARG,ARG:1,ARG:2
;
;@ダメージ試算_1,ARG,ARG:1,ARG:2
;#DIM ＣＯＯＰ回数 , 1
;;ARG 攻撃者
;;ARG:1 被攻撃者
;;ARG:2 威力
;;ARG:3 相性
;;LOCAL ダメージ
;;LOCAL:1　1moreとCO-OPのフラグていうかクリフラグ
;LOCAL:1 = 0
;IF !CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && ((MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 0 && ((HAVE_SKILL(ARG,2420) || HAVE_SKILL(ARG,2421))) == 0) || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999 || (CFLAG:(ARG:1):물리반사플래그 && ARG:3 < 4) || (CFLAG:(ARG:1):마법반사플래그 && (ARG:3 > 3 && ARG:3 != 17)))
;	RETURN 0
;ENDIF
;;リンケージの場合、能力参照者を指定できる
;IF CFLAG:ARG:링케이지발동 && !CFLAG:ARG:단독링케이지
;	TRYCCALLFORM GET_STATUS_LINKAGE{CFLAG:ARG:사용링케이지}, ARG
;		TRYCALLFORM GET_STATUS_LINKAGE{CFLAG:ARG:사용링케이지}, ARG
;		LOCALS = リンケージ参加者{RESULT}
;		SIF RESULT
;			ARG = CFLAG:ARG:LOCALS
;	CATCH
;	ENDCATCH
;ENDIF
;
;LOCAL = (100+MAXBASE:ARG:LV)*(ARG:2)*(MAXBASE:ARG:공격)*(10+MAXBASE:ARG:공격/12)
;LOCAL /= (MAXBASE:(ARG:1):방어)*100*100
;;LOCAL = POWER(MAX(1,MAXBASE:ARG:(GET_BATTLESTATUS(0)) + (ARG:2 - 100)/5),2) / MAXBASE:(ARG:1):(GET_BATTLESTATUS(2))
;
;LOCAL *= (32 + CFLAG:ARG:공격강화)
;LOCAL /= (32 + CFLAG:(ARG:1):방어강화)
;SIF GET_STATE(CFLAG:ARG:상태이상) == "POISON"
;	LOCAL /= 2
;SIF CFLAG:ARG:기합플래그
;	TIMES LOCAL , 2.5
;;乱数
;SIF LOCAL > 0
;	LOCAL += RAND:3
;LOCAL *= (9500+RAND:1000)
;LOCAL /= 10000
;	IF (HAVE_SKILL(ARG,2420) || HAVE_SKILL(ARG,2421)) && RANGE(MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) , 0 , 99) 
;		;貫通持ちは耐性と無効を無視
;		LOCAL *= MAX(100,MAXBASE:(ARG:1):(GET_TYPE(ARG:3)))
;		;ベルㆍデルは貫通でも0ダメージに
;		SIF NO:(ARG:1) == [[캐릭터:벨ㆍ데르]]
;			LOCAL = 0
;	ELSEIF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) < 100 || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999)
;		;ガードキル効果：耐性以上を完全に無視
;		LOCAL *= 100
;		;LOCAL *= MAX(100,MAXBASE:(ARG:1):(GET_TYPE(ARG:3)))
;		;ベルㆍデルは貫通でも0ダメージに
;		SIF NO:(ARG:1) == [[캐릭터:벨ㆍ데르]]
;			LOCAL = 0
;	ELSE
;		LOCAL *= MAXBASE:(ARG:1):(GET_TYPE(ARG:3))
;	ENDIF
;	LOCAL /= 100
;	;防御中のキャラにはダメージ減少
;	SIF CFLAG:(ARG:1):방어플래그
;		LOCAL /= 2
;	;後列のキャラにはダメージ減少
;	SIF (CFLAG:(ARG:1):포지션 > 3 && CFLAG:(ARG:1):포지션 < 7) || CFLAG:(ARG:1):포지션 > 11
;		TIMES LOCAL,0.70
;	LOCALS = %GET_TYPE(ARG:3)%無効化回数
;	IF CFLAG:(ARG:1):LOCALS && HAVE_SKILL(ARG,2421) == 0
;		RETURN 0
;	ENDIF
;	IF CFLAG:(ARG:1):PT플래그 > 0
;		SELECTCASE FLAG:전투난이도
;			CASE 1
;				TIMES LOCAL,0.75
;			CASE 3,4
;				TIMES LOCAL , 1.5
;			CASE 5
;				TIMES LOCAL , 2
;			CASE 6
;				TIMES LOCAL , 3
;		ENDSELECT
;	ENDIF
;	SIF CFLAG:(ARG:1):PT플래그 == 0 && FLAG:전투난이도 == 1
;		TIMES LOCAL , 1.40
;	
;	;眠っていたらダメージ大
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SLEEP")
;		TIMES LOCAL,1.5
;	;自身がオルギアでダメージ上昇
;	SIF CFLAG:ARG:상태이상 == GET_STATE_NUM("ORGY")
;		TIMES LOCAL,1.25
;	;FREEZE時は電撃、SHOCK時は氷結のダメージが倍化
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("FREEZE") && GET_TYPE(ARG:3) == "電撃" || CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SHOCK") && GET_TYPE(ARG:3) == "氷結"
;		TIMES LOCAL,2.0
;	;追撃の心得持ち+1more中は威力が1.5倍
;	SIF CFLAG:ARG:１more플래그 > 0 && HAVE_SKILL(ARG,[[스킬:추격의심득]])
;		TIMES LOCAL,1.5 
;	SELECTCASE GET_STATE(CFLAG:(ARG:1):상태이상)
;		CASE "SLEEP","SHOCK","FREEZE"
;			TIMES LOCAL , 1.50
;			LOCAL:1 += 2
;	ENDSELECT
;	;特殊ダメージ補正
;	LOCAL = LOCAL * (CFLAG:(ARG:1):물리피데미지보정 +100) / 100
;	;真ㆍ全門耐性(万能以外半減ㆍ万能倍化)
;	SIF HAVE_SKILL(ARG:1, [[스킬:진ㆍ전문내성]])
;		LOCAL = ARG:3 == 17 ? LOCAL * 2 # LOCAL / 2
;	;とりあえず1.2倍しといてみる
;RETURN LOCAL
;
;@ダメージ試算_2,ARG,ARG:1,ARG:2
;;ARG 攻撃者
;;ARG:1 被攻撃者
;;ARG:2 威力
;;ARG:3 相性
;;LOCAL ダメージ
;;リンケージの場合、能力参照者を指定できる
;IF CFLAG:ARG:링케이지발동 && !CFLAG:ARG:단독링케이지
;	;PRINTFORMW %CALLNAME:ARG%の攻撃力は{MAXBASE:ARG:마법위력}
;	TRYCCALLFORM リンケージ能力参照者_{CFLAG:ARG:사용링케이지}, ARG
;		TRYCALLFORM リンケージ能力参照者_{CFLAG:ARG:사용링케이지}, ARG
;		LOCALS = リンケージ参加者{RESULT}
;		SIF RESULT
;			ARG = CFLAG:ARG:LOCALS
;	CATCH
;	ENDCATCH
;ENDIF
;LOCAL:1 = 0
;IF !CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 0 || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999 || (CFLAG:(ARG:1):물리반사플래그 && ARG:3 < 4) || (CFLAG:(ARG:1):마법반사플래그 && (ARG:3 > 3 && ARG:3 != 17)))
;	RETURN 0
;ENDIF
;;LOCAL = ((MAXBASE:ARG:(GET_BATTLESTATUS(4)) * 2 * (MAXBASE:ARG:(GET_BATTLESTATUS(4))/8+1))/16+MAXBASE:ARG:(GET_BATTLESTATUS(4))+8) * (ARG:2 + MAXBASE:ARG:(GET_BATTLESTATUS(4))/4+1) / (MAXBASE:(ARG:1):마법효과 + MAXBASE:(ARG:1):방어/2 + MAXBASE:(ARG:1):마법위력/4)
;;LOCAL = ((MAXBASE:ARG:(GET_BATTLESTATUS(4)) * 2 * (MAXBASE:ARG:(GET_BATTLESTATUS(4))*3/8+1))/16+MAXBASE:ARG:(GET_BATTLESTATUS(4))+8) * (ARG:2) / (MAXBASE:(ARG:1):마법효과 + MAXBASE:(ARG:1):방어/2 + MAXBASE:(ARG:1):마법위력/4)
;
;LOCAL = (100+MAXBASE:ARG:LV)*(ARG:2)*(MAXBASE:ARG:마법위력)*(10+MAXBASE:ARG:마법위력/12)
;LOCAL /= ((MAXBASE:(ARG:1):마법효과*2+MAXBASE:(ARG:1):방어)/3)*100*100
;
;;乱数
;SIF LOCAL > 0
;	LOCAL += RAND:3
;LOCAL *= (32 + CFLAG:ARG:마법위력강화)
;LOCAL /= (32 + CFLAG:(ARG:1):방어강화)
;SIF CFLAG:ARG:집중플래그
;	TIMES LOCAL , 2.5
;LOCAL *= (9500+RAND:1000)
;LOCAL /= 10000
;	LOCALS = %GET_TYPE(ARG:3)%無効化回数
;	IF CFLAG:(ARG:1):LOCALS && HAVE_SKILL(ARG,2421) == 0
;		LOCAL = 0
;	ENDIF
;	IF CFLAG:(ARG:1):(GET_TYPE(ARG:3) + "ガードキル") && (MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) < 100 || MAXBASE:(ARG:1):(GET_TYPE(ARG:3)) == 999)
;		;ガードキル効果：耐性以上を完全に無視
;		LOCAL *= 100
;		;LOCAL *= MAX(100,MAXBASE:(ARG:1):(GET_TYPE(ARG:3)))
;		;ベルㆍデルは貫通でも0ダメージに
;		SIF NO:(ARG:1) == [[캐릭터:벨ㆍ데르]]
;			LOCAL = 0
;	ELSE
;		LOCAL *= MAXBASE:(ARG:1):(GET_TYPE(ARG:3))
;	ENDIF
;	LOCAL /= 100
;	SIF CFLAG:(ARG:1):방어플래그
;		LOCAL /= 2
;	;後列のキャラにはダメージ減少
;	SIF (CFLAG:(ARG:1):포지션 > 3 && CFLAG:(ARG:1):포지션 < 7) || CFLAG:(ARG:1):포지션 > 11
;		TIMES LOCAL,0.70
;	;難易度修正
;	IF CFLAG:(ARG:1):PT플래그 > 0
;		SELECTCASE FLAG:전투난이도
;			CASE 1
;				TIMES LOCAL,0.75
;			CASE 3,4
;				TIMES LOCAL , 1.5
;			CASE 5
;				TIMES LOCAL , 2
;			CASE 6
;				TIMES LOCAL , 3
;		ENDSELECT
;	ENDIF
;	SIF CFLAG:(ARG:1):PT플래그 == 0 && FLAG:전투난이도 == 1
;		TIMES LOCAL , 1.40
;	;眠っていたらダメージ大
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SLEEP")
;		TIMES LOCAL,1.5
;	;自身がオルギアでダメージ上昇
;	SIF CFLAG:ARG:상태이상 == GET_STATE_NUM("ORGY")
;		TIMES LOCAL,1.25
;	;FREEZE時は電撃、SHOCK時は氷結のダメージが倍化
;	SIF CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("FREEZE") && GET_TYPE(ARG:3) == "電撃" || CFLAG:(ARG:1):상태이상 == GET_STATE_NUM("SHOCK") && GET_TYPE(ARG:3) == "氷結"
;		TIMES LOCAL,2.0
;	;追撃の心得持ち+1more中は威力が1.5倍
;	SIF CFLAG:ARG:１more플래그 > 0 && HAVE_SKILL(ARG,[[스킬:추격의심득]])
;		TIMES LOCAL,1.5 
;	LOCAL = LOCAL * (CFLAG:(ARG:1):마법피데미지보정 +100) / 100
;	;真ㆍ全門耐性(万能以外半減ㆍ万能倍化)
;	SIF HAVE_SKILL(ARG:1, [[스킬:진ㆍ전문내성]])
;		LOCAL = ARG:3 == 17 ? LOCAL * 2 # LOCAL / 2
;RETURN LOCAL
;---- EDIT 002 DEL END   ---------------------------



;=================================================
;   sub BTL_CHK_リンケージ
;=================================================
;   BTL:リンケージチェック
;-------------------------------------------------
; Input:
;  ARG:0				対象者
; Output:
;  RETURN				チェック結果のキャラ
;-------------------------------------------------
@BTL_CHK_링케이지(ARG:0)
#DIM L_P
L_P = ARG:0

;リンケージの場合、能力参照者を指定できる
IF CFLAG:L_P:링케이지발동 && !CFLAG:L_P:단독링케이지
	TRYCCALLFORM 링케이지능력참조자_{CFLAG:L_P:사용링케이지}, L_P
		TRYCALLFORM 링케이지능력참조자_{CFLAG:L_P:사용링케이지}, L_P
		SIF RESULT
			L_P = CFLAG:L_P:@"링케이지참가자{RESULT}"
	CATCH
	ENDCATCH
ENDIF

RETURN L_P

;=================================================
;   sub BTL_CHK_SKILL_貫通
;=================================================
;   BTL:スキルチェック(貫通)
;-------------------------------------------------
; Input:
;  ARG:0				対象者
;  ARG:1				攻撃タイプ　1.物理　2.魔法;024
;  ARG:2				攻撃相性　0.剣撃～17.万能;024
; Output:
;  RETURNF				真偽値
;-------------------------------------------------
@BTL_CHK_SKILL_관통(ARG:0,ARG:1 = 1,ARG:2 = -1)
#FUNCTION
#DIM L_P
L_P = ARG:0

;貫通スキル有りの場合

;物理攻撃の場合
IF ARG:1 == 1
	;---- EDIT 017 018 ADD ---------------------------
	SIF HAVE_SKILL(L_P,[[스킬:아버지의이름에맹세코]]) || HAVE_SKILL(L_P,[[스킬:조금만더힘을]])
		RETURNF 1

	;沖田　絶刀を持っている。
	SIF HAVE_PU_SKILL(ARG,"絶刀")
		RETURNF 1

	;---- EDIT 038 ADD START ---------------------------
	;影霄ㆍ絶影起動中は魔法攻撃に限り、貫通フラグを立てる
	SIF SKILLGAGE_F_GET(ARG,PU_SKILLNUM_GET(ARG,"影霄ㆍ絶影")) < 0
		RETURNF 1
	;---- EDIT 038 ADD END   ---------------------------
	;東方ＭＯＤEXㆍアナーキーバレットヘル
	IF HAVE_SKILL(L_P,[[스킬:관통]]) || HAVE_SKILL(L_P,[[스킬:영세라이도우]]) || HAVE_SKILL(L_P,2989)|| HAVE_SKILL(L_P,2947)
		RETURNF 1
	ELSE
		RETURNF 0
	ENDIF
;魔法攻撃の場合
ELSEIF ARG:1 == 2
	;---- EDIT 038 ADD START ---------------------------
	;キメラ起動中は魔法攻撃に限り、貫通フラグを立てる
	SIF SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"キメラ")) < 0
		RETURNF 1
	;---- EDIT 038 ADD END   -------------------------
ENDIF

;=================================================
;   sub BTL_CALC_DAMAGE_BLOCK
;=================================================
;   BTL計算:ダメージブロック
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:3				攻撃相性
;  ARG:4				ダメージタイプ(1:物理 2:魔法)
; Output:
;  RETURNF				真偽値
;-------------------------------------------------
@BTL_CALC_DAMAGE_BLOCK(ARG:0, ARG:1, ARG:3, ARG:4)
#FUNCTION
#DIM L_P
#DIM L_T
#DIMS L_相性名
#DIM L_相性番号
#DIM L_相性値
#DIM L_BLOCK
#DIM L_ダメージタイプ
#DIM L_ガードキル
#DIM L_貫通フラグ;024

;-----------------------------
;- 初期処理
;-----------------------------

L_P		= ARG:0
L_T		= ARG:1
L_ダメージタイプ = ARG:4

L_相性番号	= ARG:3
L_相性名	= %GET_TYPE(L_相性番号)%
L_相性値	= MAXBASE:L_T:L_相性名

;-----------------------------
;- 前処理
;-----------------------------
L_BLOCK=0
L_ガードキル=CFLAG:L_T:(L_相性名 + "가드킬")

L_貫通フラグ = BTL_CHK_SKILL_관통(L_P,L_ダメージタイプ,L_相性値);024
;物理ダメージで貫通スキル有りの場合
;IF (L_ダメージタイプ == 1) && BTL_CHK_SKILL_관통(L_P)
;	L_物理貫通フラグ = 1
;ELSE
;	L_物理貫通フラグ = 0
;ENDIF


;-----------------------------
;- ブロック判定
;-----------------------------

;人間不可侵&人間からの攻撃
IF HAVE_SKILL(L_T,2506) && ABL:L_P:종족 == 0 && NO:L_P != [[캐릭터:코로마루]] && (!CFLAG:L_P:악마변신 || TALENT:L_P:이능자 || TALENT:L_P:이능자 || TALENT:L_P:서머너 || TALENT:L_P:페르소나구사자)
	L_BLOCK=1
;ガードキル未発動 且つ 反射
ELSEIF !L_ガードキル && (L_相性値 == 999)
	L_BLOCK=1
;ガードキル未発動 且つ 無効で貫通無し
ELSEIF !L_ガードキル && ( (L_相性値 == 0) && !L_貫通フラグ );024
	L_BLOCK=1
;物理反射
ELSEIF (CFLAG:L_T:물리반사플래그 && L_相性番号 < 4)
	L_BLOCK=1
;魔法反射
ELSEIF (CFLAG:L_T:마법반사플래그 && (L_相性番号 > 3 && L_相性番号 != 17) )
	L_BLOCK=1
ELSEIF (CFLAG:L_T:무효플래그 && L_相性番号 != 17)
	L_BLOCK=1
;ウェイト
ELSEIF (CFLAG:L_T:(L_相性名 + "웨이트") == 2)
	L_BLOCK=1
ENDIF

RETURNF L_BLOCK


;=================================================
;   sub BTL_CALC_BASE_DAMAGE
;=================================================
;   BTL計算:基礎ダメージ
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:2				威力
;  ARGS					計算タイプ(物理/魔法/銃)
; Output:
;  RETURN				ダメージ
;-------------------------------------------------
@BTL_CALC_BASE_DAMAGE(ARG:0, ARG:1, ARG:2, ARGS)
#DIM L_P
#DIM L_T
#DIM L_威力
#DIM L_DMG
#DIM L_攻撃値
#DIM L_防御値
#DIMS L_TYPE

L_P		= ARG:0
L_T		= ARG:1
L_威力	= ARG:2
L_DMG=0
;---- EDIT 022 MOD START -------------------------
L_TYPE '= ARGS
IF BATTLE_SETTING_IS_ITEM_DAMAGE() && L_P == FLAG:행동순1 && INRANGE(CFLAG:L_P:입력행동,3001, 3500)
	DEBUGPRINTFORML [%CALLNAME:L_P%]%SKILL_NAME_F(CFLAG:L_P:입력행동)%=>[%CALLNAME:L_T%] 도구 위력으로 판정합니다
	L_TYPE = 도구
ENDIF

;-----------------------------
;- 計算タイプ別チェック
;-----------------------------
SELECTCASE L_TYPE
	CASE "물리"
		L_DMG = (100+MAXBASE:L_P:LV)*(L_威力)*(MAXBASE:L_P:공격)*(10+MAXBASE:L_P:공격/12)
		L_DMG /= (MAXBASE:L_T:방어)*100*100

	CASE "마법"
		L_DMG = (100+MAXBASE:L_P:LV)*(L_威力)*(MAXBASE:L_P:마법위력)*(10+MAXBASE:L_P:마법위력/12)
		L_DMG /= ((MAXBASE:L_T:마법효과*2+MAXBASE:L_T:방어)/3)*100*100

	CASE "총"
		L_DMG = (100+MAXBASE:L_P:LV)*(L_威力)*(MAXBASE:L_P:총공격)*(10+MAXBASE:L_P:총공격/12)
		L_DMG /= (MAXBASE:L_T:방어)*100*100

	CASE "도구"
		L_DMG = (100+MAXBASE:L_P:LV)*(L_威力)*(MAXBASE:L_P:도구위력)*(10+MAXBASE:L_P:도구위력/12)
		IF ARGS == "물리" || ARGS == "총"
			L_DMG /= (MAXBASE:L_T:방어)*100*100
		ELSE
			L_DMG /= ((MAXBASE:L_T:마법효과*2+MAXBASE:L_T:방어)/3)*100*100
		ENDIF
;---- EDIT 022 MOD END -------------------------

	CASEELSE
		;エラー
		RETURN 0
ENDSELECT

;-----------------------------
;- 基本調整
;-----------------------------

;乱数
SIF L_DMG > 0
	L_DMG += RAND:3
L_DMG *= (9500+RAND:1000)
L_DMG /= 10000

;-----------------------------
;- 終了
;-----------------------------
RETURN L_DMG



;=================================================
;   sub BTL_CALC_DAMAGE_ADJUSTMENT
;=================================================
;   BTL計算:ダメージ調整
;-------------------------------------------------
;   入力されたダメージを、必要に応じて調整する
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:2				ダメージ値
;  ARG:3				攻撃相性
;  ARG:4				ダメージタイプ(1:物理 2:魔法)
; Output:
;  RETURN				ダメージ値
;-------------------------------------------------
@BTL_CALC_DAMAGE_ADJUSTMENT(ARG:0, ARG:1, ARG:2, ARG:3, ARG:4)
#DIM L_P
#DIM L_T
#DIM L_DMG
#DIMS L_相性名
#DIM L_相性値
#DIM L_貫通フラグ;024
#DIM L_ダメージタイプ
;---- EDIT 012 ADD ------
#DIM L_武器素質P

;-----------------------------
;- 初期処理
;-----------------------------

L_P		= ARG:0
L_T		= ARG:1
L_DMG	= ARG:2
L_ダメージタイプ = ARG:4

L_相性名	= %GET_TYPE(ARG:3)%
L_相性値	= MAXBASE:L_T:L_相性名

;---- EDIT 012 ADD START ---------------------------
CALL MATCHING_WEAPON_CHECK(L_P)
L_武器素質P = RESULT
CALL WEAPON_STYLE_CHECK(L_P,RESULT)
;3ケタ以降は型
L_武器素質P += RESULT * 100
;---- EDIT 012 ADD END   ---------------------------

;-----------------------------
;- ダメージタイプ別チェック
;-----------------------------

;- 物理ダメージタイプ
IF (L_ダメージタイプ == 1)
	;---- EDIT 038 ADD START ---------------------------
	;影霄ㆍ絶影用特殊処理
	IF SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) < 0
		IF SKILLGAGE_H_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) >= 10000 || SKILLGAGE_H_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) >= -1
			L_DMG *= 2
			GOTO AN_CHIMAERA_SKIP
		ENDIF
	ENDIF
	;---- EDIT 038 ADD END   ---------------------------
	SIF CFLAG:L_P:방어반감플래그 == 1
		L_DMG *= 2
	;IF CFLAG:L_P:기합플래그 && !FLAG:카운터중
	;	IF CFLAG:L_P:기합플래그 == 2
	;		TIMES L_DMG , 3.0
	;	ELSE
	;		TIMES L_DMG , 2.5
	;	ENDIF
	;ENDIF
	;特殊ダメージ補正
	L_DMG = L_DMG * (CFLAG:L_T:물리피데미지보정 +100) / 100
	;---- EDIT 040 ADD START 与ダメージ補正、各属性ダメージ補正のプレイヤーサイド有効化---------------------------
	;SIF !CFLAG:L_P:PT플래그
		L_DMG = L_DMG * (CFLAG:L_P:물리여데미지보정 +100) / 100
	;---- EDIT 040 ADD END---------------------------

	L_DMG *= (32 + CFLAG:L_P:공격강화)
	L_DMG /= (32 + CFLAG:L_T:방어강화)


;- 魔法ダメージタイプ
ELSE
	;---- EDIT 038 ADD START ---------------------------
	;キメラ用特殊処理
	IF SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"キメラ")) < 0
		L_DMG *= 2
		GOTO AN_CHIMAERA_SKIP
	ENDIF
	;---- EDIT 038 ADD END   ---------------------------
	SIF CFLAG:L_P:마법효과반감플래그 == 1
		L_DMG *= 2
	;SIF CFLAG:L_P:집중플래그 && !FLAG:카운터중
	;	TIMES L_DMG , 2.5

	;特殊ダメージ補正
	L_DMG = L_DMG * (CFLAG:L_T:마법피데미지보정 +100) / 100
	;---- EDIT 040 ADD START 与ダメージ補正、各属性ダメージ補正のプレイヤーサイド有効化---------------------------
	;SIF !CFLAG:L_P:PT플래그
		L_DMG = L_DMG * (CFLAG:L_P:마법여데미지보정 +100) / 100

	L_DMG *= (32 + CFLAG:L_P:마법위력강화)
	L_DMG /= (32 + CFLAG:L_T:마법효과강화)
ENDIF

;SIF !CFLAG:L_T:PT플래그
	L_DMG = L_DMG * (CFLAG:L_T:(L_相性名 + "피데미지보정") +100) / 100
;SIF !CFLAG:L_P:PT플래그
	L_DMG = L_DMG * (CFLAG:L_P:(L_相性名 + "여데미지보정") +100) / 100
	;---- EDIT 040 ADD END ---------------------------

$AN_CHIMAERA_SKIP


;-----------------------------
;- 耐性処理
;-----------------------------

L_貫通フラグ = BTL_CHK_SKILL_관통(L_P,L_ダメージタイプ,L_相性値);024
;物理ダメージで貫通スキル有りの場合
;IF (L_ダメージタイプ == 1) && BTL_CHK_SKILL_관통(L_P)
;	L_物理貫通フラグ = 1
;ELSE
;	L_物理貫通フラグ = 0
;ENDIF


;ドレイン状態
IF CFLAG:L_T:(L_相性名 + "웨이트") == 3 
	L_DMG *= -50
;物理ダメージタイプで貫通
;ELSEIF L_物理貫通フラグ && L_相性値 >= 0
ELSEIF L_貫通フラグ && L_相性値 >= 0 && L_相性値 != 999;024
	;貫通持ちは耐性と無効を無視
	L_DMG *= MAX(100, L_相性値)
	;ベルㆍデルは貫通でも0ダメージに
	SIF NO:L_T == [[캐릭터:벨ㆍ데르]]
		L_DMG = 0
;ガードキル
ELSEIF CFLAG:L_T:(L_相性名 + "가드킬") && (L_相性値 < 100 || L_相性値 == 999)
	;ガードキル効果：耐性以上を完全に無視
	L_DMG *= 100
	;ベルㆍデルは貫通でも0ダメージに
	SIF NO:L_T == [[캐릭터:벨ㆍ데르]]
		L_DMG = 0
ELSE
	L_DMG *= L_相性値
ENDIF
L_DMG /= 100


;-----------------------------
;- 無効系処理
;-----------------------------
;東方ＭＯＤEXㆍアナーキーバレットヘル。
;IF (HAVE_SKILL(L_P,[[스킬:영세라이도우]]) ||HAVE_SKILL(L_P,2947)) == 0
;	IF CFLAG:L_T:(L_相性名 + "無効化回数")
;		L_DMG = 0
;		CFLAG:L_T:(L_相性名 + "被弾") = 1
;	ENDIF
;	;◯◯ブレイク
;	SIF CFLAG:L_T:(L_相性名 + "ウェイト") == 1
;		L_DMG = 0
;ENDIF
;---- EDIT 038 ADD START ---------------------------
;該当の条件を満たしたら無効化処理はすっ飛ばして共通チェックに移行する
SIF HAVE_SKILL(L_P,[[스킬:영세라이도우]]) || HAVE_SKILL(L_P,2947) || ((HAVE_PU_SKILL(L_P,"絶刀") && HAVE_PU_SKILL(L_P,"病弱"))) == 0
	GOTO SKIP_DAMAGE_NULLIFY
SIF L_ダメージタイプ == 2 && SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"キメラ")) < 0 || L_ダメージタイプ == 1 && SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) < 0
	GOTO SKIP_DAMAGE_NULLIFY
IF CFLAG:L_T:(L_相性名 + "무효화횟수")
	L_DMG = 0
	CFLAG:L_T:(L_相性名 + "피탄") = 1
ENDIF
;◯◯브레이크
SIF CFLAG:L_T:(L_相性名 + "웨이트") == 1
	L_DMG = 0
;---- EDIT 038 ADD END   ---------------------------

;-----------------------------
;- 共通チェック
;-----------------------------

;---- EDIT 038 ADD START ---------------------------
$SKIP_DAMAGE_NULLIFY
;---- EDIT 038 ADD END   ---------------------------

;防御中のキャラにはダメージ減少
SIF CFLAG:L_T:방어플래그
	L_DMG /= 2

;---- EDIT 012 ADD ------
;槍、投具の二ノ型の場合後列への攻撃減少なし(銃を除く)
IF !FLAG:총공격중 && ((L_武器素質P == 205 && L_ダメージタイプ == 1) || (L_武器素質P == 208 && L_ダメージタイプ == 2))
;後列のキャラにはダメージ減少
ELSEIF (CFLAG:L_T:포지션 > 3 && CFLAG:L_T:포지션 < 7) || CFLAG:L_T:포지션 > 11
	TIMES L_DMG,0.70
ENDIF

;自身が幸せだとダメージ減少
SIF CFLAG:L_P:상태이상 == GET_STATE_NUM("HAPPY")
	TIMES L_DMG,0.70

;自身が蝿でダメージ減少
SIF CFLAG:L_P:상태이상 == GET_STATE_NUM("FLY")
	TIMES L_DMG,0.50

IF CFLAG:L_T:PT플래그 > 0
	SELECTCASE FLAG:전투난이도
		CASE 1
			TIMES L_DMG,0.75
		CASE 3,4
			TIMES L_DMG , 1.5
		CASE 5
			TIMES L_DMG , 2
		CASE 6
			TIMES L_DMG , 3
	ENDSELECT
ENDIF

;難易度EASYなら敵へのダメージ大
SIF CFLAG:L_T:PT플래그 == 0 && FLAG:전투난이도 == 1
	TIMES L_DMG , 1.40
;幸せだとダメージ大
SIF CFLAG:L_T:상태이상 == GET_STATE_NUM("HAPPY")
	TIMES L_DMG,1.25
;眠っていたらダメージ大
SIF CFLAG:L_T:상태이상 == GET_STATE_NUM("SLEEP")
	TIMES L_DMG,1.5
;蝿状態ならダメージ大
SIF CFLAG:L_T:상태이상 == GET_STATE_NUM("FLY")
	TIMES L_DMG,1.5
;自身がオルギアでダメージ上昇
SIF CFLAG:L_P:상태이상 == GET_STATE_NUM("ORGY")
	TIMES L_DMG,1.25

;- 特定の状態異常時、ダメージが倍化
SELECTCASE GET_STATE(CFLAG:L_T:상태이상)
	;- FREEZE時は電撃、地変
	CASE "FREEZE"
		SIF L_相性名 == "전격" || L_相性名 == "지변"
			TIMES L_DMG,2.0
			
	;- SHOCK時は氷結、水撃
	CASE "SHOCK"
		SIF L_相性名 == "빙결" || L_相性名 == "수격"
			TIMES L_DMG,2.0
			
	;- SLIP時は重力、物理
	CASE "SLIP"
		IF L_相性名 == "중력" || L_相性名 == "검격" || L_相性名 == "타격" || L_相性名 == "비구" || L_相性名 == "전술"
			TIMES L_DMG,1.7
			SIF L_相性名 == "중력"
				CFLAG:L_T:SLIP중중력피탄플래그 = 1
		ENDIF
		
	;- FLAME時は疾風、核熱
	CASE "FLAME"
		SIF L_相性名 == "질풍" || L_相性名 == "핵열"
			TIMES L_DMG,1.5
			
ENDSELECT
;more系
;追撃の心得持ち+1more中は威力が1.5倍
SIF CFLAG:L_T:１more플래그 > 900 && HAVE_SKILL(L_T,[[스킬:추격의심득]])
	TIMES L_DMG,1.5 

;真ㆍ全門耐性(万能以外半減ㆍ万能倍化)
SIF HAVE_SKILL(L_T, [[스킬:진ㆍ전문내성]])
	L_DMG = (L_相性名 == "만능") ? L_DMG * 2 # L_DMG / 2



;-----------------------------
;- 終了
;-----------------------------
RETURN L_DMG


;=================================================
;   sub BTL_CALC_DAMAGE_EXE
;=================================================
;   BTL計算:ダメージ実行
;-------------------------------------------------
;   入力されたダメージ値を基に、ダメージを反映する
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:2				ダメージ値
;  ARG:3				攻撃相性
;  ARG:4				ダメージタイプ(1:物理 2:魔法)
;  ARG:5				クリティカル率(%)
;  ARG:6				吸収率(%)
; Output:
;  RESULT:0				ダメージ値
;  RESULT:1				クリティカルフラグ
;-------------------------------------------------
@BTL_CALC_DAMAGE_EXE(ARG:0, ARG:1, ARG:2, ARG:3, ARG:4, ARG:5, ARG:6)
#DIM L_P
#DIM L_T
#DIM L_DMG
#DIMS L_相性名
#DIM L_相性値
#DIM L_物理貫通フラグ
#DIM L_ダメージタイプ
#DIM L_CRT
#DIM L_ABS
#DIM L_吸収量
;---- EDIT 012 ADD ------
#DIM L_武器素質P
#DIM L_武器素質T
;---- EDIT 013 ADD ------
#DIM L_ダメージ補正
;---- EDIT 014 ADD ------
#DIM L_クリ強化補正
#DIM L_COUNT

;-----------------------------
;- 初期処理
;-----------------------------

L_P		= ARG:0
L_T		= ARG:1
L_DMG	= ARG:2
L_ダメージタイプ = ARG:4
L_CRT   = 0
L_ABS	= ARG:6

L_相性名	= %GET_TYPE(ARG:3)%
L_相性値	= MAXBASE:L_T:L_相性名

;---- EDIT 012 ADD START ---------------------------
CALL MATCHING_WEAPON_CHECK(L_P)
L_武器素質P = RESULT
CALL WEAPON_STYLE_CHECK(L_P,RESULT)
;3ケタ以降は型
L_武器素質P += RESULT * 100

CALL MATCHING_WEAPON_CHECK(L_T)
L_武器素質T = RESULT
CALL WEAPON_STYLE_CHECK(L_T,RESULT)
;3ケタ以降は型
L_武器素質T += RESULT * 100
;---- EDIT 012 ADD END   ---------------------------
;-----------------------------
;- ダメージタイプ別チェック
;-----------------------------

;自分か相手がプリンキピアを持っているのならCRITICALはキャンセルされる
IF HAVE_SKILL(L_P, [[스킬:프린키피아]]) || HAVE_SKILL(L_T, [[스킬:프린키피아]]) || (!CFLAG:L_T:PT플래그 && CFLAG:L_T:크리티컬무효플래그)
	L_CRT = 0
;EDIT40 物理ダメージかつ攻撃側に会心確定フラグが立っている場合強制必殺
;　鬼　の　よ　う　に　強　力　な　の　で　常に使用可能なスキルには搭載しない事。
ELSEIF CFLAG:L_P:회심확정플래그 && (L_ダメージタイプ == 1)
		TIMES L_DMG , 1.50
		;EDIT39 攻撃役が会心専心を持っていた場合更に1.3倍＝ダメージ量195%
		SIF HAVE_SKILL(L_P, [[스킬:회심전심]])
			TIMES L_DMG , 1.30
		PRINTFORM 《CRITICAL》 
		SETBIT L_CRT, 2
;- 物理ダメージタイプ
ELSEIF (L_ダメージタイプ == 1)
	;物理クリティカル判定
;---- EDIT 014 ADD START ---------------------------
;---- EDIT 021 ---------------------------
	L_クリ強化補正 = 100
	;---- EDIT 040 ADD START 会心率強化と切り落としの必中を独立に---------------------------	
	;L_クリ強化補正 += (!FLAG:총공격중 && !FLAG:카운터중 && CFLAG:L_P:베어내기플래그) * 20
	L_クリ強化補正 += (!FLAG:총공격중 && !FLAG:카운터중 && CFLAG:L_P:회심률강화플래그) * 50
	;---- EDIT 040 ADD END---------------------------	
	
	;攻撃側が「与クリティカル率減少」（粗雑）を持っていたらクリティカル率が減少
	SIF HAVE_SKILL(L_P,[[스킬:조잡]])
		L_クリ強化補正 = MAX(1, L_クリ強化補正 - 20)

	;受け手側が「被クリティカル率上昇」（慢心）を持っていたらクリティカル率増大
	SIF HAVE_SKILL(L_T,[[스킬:자만심]])
		L_クリ強化補正 += 20

	L_クリ強化補正 += CFLAG:L_P:크리티컬보정
	
	L_クリ強化補正 *= (10 + MAXBASE:L_P:운)
	L_クリ強化補正 /= (10 + MAXBASE:L_T:운) 
	L_クリ強化補正 *= (CFLAG:L_P:크리티컬강화+8)
	L_クリ強化補正 /= 8
	;---- EDIT 025 ADD START ---------------------------
	;---- EDIT 029 ADD START ---------------------------
	;---- EDIT 031 MOD START --------------------------
	{
	    L_クリ強化補正 *= 
			(HAVE_SKILL(L_P,[[스킬:어드바이스]]) > 0)
			+ (HAVE_SKILL(L_P,[[스킬:서드아이]]) > 0)
			+ (HAVE_SKILL(L_P,PU_SKILLNUM_GET(L_P,"ランサー")) > 0) 
			+ (HAVE_PU_SKILL(L_P,"アサシン") > 0)
			+ (HAVE_PU_SKILL(L_P,"直感") > 0)
			+ (HAVE_PU_SKILL(L_P,"セイバーの星") > 0)
			+ ((HAVE_PU_SKILL(L_P,"刹那無影剣") > 0) * 2)
			;---- EDIT KR_01 ADD START -------------------------------
			+ (HAVE_SKILL(L_P,[[스킬:평정심유지]]) > 0)
			+ (HAVE_SKILL(L_P,[[스킬:거대한폭발]]) > 0)
			+ (HAVE_SKILL(L_P,[[스킬:리퍼영혼수확]]) > 0)
			+ (HAVE_SKILL(L_P,[[스킬:헌터의본능]]) > 0)
			+ (HAVE_SKILL(L_P,[[스킬:데드샷]]) > 0)
			;---- EDIT KR_01 ADD END ---------------------------------
			+ 1
	}
	{
		L_クリ強化補正 /= 
			(HAVE_SKILL(L_T,[[스킬:코칭]]) > 0) 
			+ (HAVE_SKILL(L_T,[[스킬:에어하이크]]) > 0) 
			+ (HAVE_SKILL(L_T,[[스킬:롤링블레이즈]]) > 0)
			+ (HAVE_SKILL(L_T,[[스킬:서드아이]]) > 0) 
			+ (HAVE_SKILL(L_T,PU_SKILLNUM_GET(L_T,"ランサー")) > 0) 
			+ (HAVE_PU_SKILL(L_T,"直感") > 0) 
			+ (HAVE_PU_SKILL(L_T,"セイバーの星") > 0) 
			+ (HAVE_PU_SKILL(L_T,"刹那無影剣") > 0)
			+ 1
	}

	;---- EDIT 031 MOD END ----------------------------
	;---- EDIT 025 ADD END -----------------------------
	;---- EDIT 029 ADD END ---------------------------
;---- EDIT 014 ADD END ---------------------------
	
	;ゲッシュ所持かつ、誓いを守れているかで補正が発生(;誓い（Fゲージ）0=プラス補正、-1=マイナス補正)
	;攻め手用
	IF HAVE_PU_SKILL(L_P,"ゲッシュ") && SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"ゲッシュ")) == -1
		L_クリ強化補正 /= 2
	ELSE
		L_クリ強化補正 *= 2
	ENDIF
	;受け手用
	IF HAVE_PU_SKILL(L_T,"ゲッシュ") && SKILLGAGE_F_GET(L_T,PU_SKILLNUM_GET(L_T,"ゲッシュ")) == -1
		L_クリ強化補正 *= 2
	ELSE
		L_クリ強化補正 /= 2
	ENDIF
;---- EDIT 031 MOD END ----------------------------
	IF RAND:100 < ARG:5 * L_クリ強化補正 / 100
		TIMES L_DMG , 1.50
		;EDIT40 攻撃役が会心専心を持っていた場合更に1.3倍＝ダメージ量195%
		SIF HAVE_SKILL(L_P, [[스킬:회심전심]])
			TIMES L_DMG , 1.30
		PRINTFORM 《CRITICAL》 
		SETBIT L_CRT, 2
;---- EDIT 003 ADD START ---------------------------
	ELSEIF (HAVE_SKILL(L_P, [[스킬:황천의회심]]) && FLAG:월령 == 8) || (HAVE_SKILL(L_P, [[스킬:정천의회심]]) && FLAG:월령 == 0)
;---- EDIT 003 ADD END   ---------------------------
		TIMES L_DMG , 1.50
		;EDIT40 攻撃役が会心専心を持っていた場合更に1.3倍＝ダメージ量195%
		SIF HAVE_SKILL(L_P, [[스킬:회심전심]])
			TIMES L_DMG , 1.30
		PRINTFORM 《CRITICAL》 
		SETBIT L_CRT, 2
	ELSE
		SELECTCASE GET_STATE(CFLAG:L_T:상태이상)
			CASE "SLEEP","SHOCK","FREEZE"
				TIMES L_DMG , 1.50
				;EDIT40 攻撃役が会心専心を持っていた場合更に1.3倍＝ダメージ量195%
				SIF HAVE_SKILL(L_P, [[스킬:회심전심]])
					TIMES L_DMG , 1.30
				PRINTFORM 《CRITICAL》 
				SETBIT L_CRT, 2
			;---- EDIT 029 ADD START ---------------------------
			CASEELSE
				;専用技の内、CRT_CONTINUE_%関数名%が存在した場合、
				;その中の条件を満たしたかどうかでクリティカル継続の成否を判定する
				CALL PU_CRT_CONTINUE,L_P,L_T
				IF RESULT == 1
					TIMES L_DMG , 1.50
					;EDIT40 攻撃役が会心専心を持っていた場合更に1.3倍＝ダメージ量195%
					SIF HAVE_SKILL(L_P, [[스킬:회심전심]])
						TIMES L_DMG , 1.30
					PRINTFORM 《CRITICAL》 
					SETBIT L_CRT, 2
				ENDIF
			;---- EDIT 029 ADD END ---------------------------
		ENDSELECT
	ENDIF
	;---- EDIT 029 ADD START ---------------------------
	CALL CRT_CHECK,L_CRT
	;---- EDIT 029 ADD END ---------------------------
;- 魔法ダメージタイプ
ELSE

	;物理クリティカルは無し
	L_CRT=0

ENDIF
;独覚処理
IF CFLAG:L_T:독각플래그 == 2 && L_相性値 > 100 && L_相性値 != 999 && L_DMG > 0
	L_DMG *= -1
ENDIF
;-----------------------------
;- 共通チェック
;-----------------------------

;---- EDIT 013 ADD START ---------------------------

;---- スキルによるダメージアップ
L_ダメージ補正 = 100
	;EDIT40 攻撃役が会心専心を持っていて必殺でなかった場合、ダメージ量が10%下がる
	SIF HAVE_SKILL(L_P, [[스킬:회심전심]]) && L_CRT == 0
		L_ダメージ補正 -= 10

;---- EDIT 037 ADD START ---------------------------
;キメラ起動中、魔法攻撃だった場合はダメージタイプを「なし」として扱う
SIF SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"キメラ")) < 0 && L_ダメージタイプ == 2
	L_ダメージタイプ = 0
;影霄ㆍ絶影の最後の一撃と、その後のスキル効果時間中は物理攻撃のダメージタイプを「なし」として扱う
SIF (SKILLGAGE_F_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) < 0 && L_ダメージタイプ == 1) && (SKILLGAGE_H_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) >= 10000 || SKILLGAGE_H_GET(L_P,PU_SKILLNUM_GET(L_P,"影霄ㆍ絶影")) > -1)
	L_ダメージタイプ = 0
;---- EDIT 038 ADD END   ---------------------------
;---- EDIT 017 DEL ---------------------------
;父の名に誓って持ちはダメージが+50%
;SIF HAVE_SKILL(L_P,[[스킬:아버지의이름에맹세코]])
;---- EDIT 017 ADD START ---------------------------
;父の名に誓って持ちは弱点、クリティカルダメージが+30%
SIF HAVE_SKILL(L_P,[[스킬:아버지의이름에맹세코]]) && (L_CRT > 0 || (L_相性値 > 100 && L_相性値 != 999))
	L_ダメージ補正 += 30
;デビルトリガー中はダメージが+50%
SIF SKILLGAGE_D_GET(L_P,[[스킬:데빌트리거]])
	L_ダメージ補正 += 50
;---- EDIT 017 ADD END ---------------------------
;---- EDIT 018 ADD START ---------------------------
;もっと力を持ちは反撃、追撃、クリティカルダメージが+30%
SIF HAVE_SKILL(L_P,[[스킬:조금만더힘을]]) && (L_CRT > 0 || FLAG:카운터중)
	L_ダメージ補正 += 30
;---- EDIT 018 ADD END ---------------------------

;---- EDIT 015 ADD START ---------------------------
;クライマックスレヴュー展開中はダメージが+25％
SIF SKILLGAGE_D_GET(ARG,3588)
	L_ダメージ補正 += 25
;---- EDIT 015 ADD END ---------------------------
;怒り状態で+20%
IF SKILLGAGE_D_GET(ARG,[[스킬:분노폭발]])
	L_ダメージ補正 += 20
	;怒り爆発でさらに+10%
	SIF SKILLGAGE_H_GET(ARG,[[스킬:분노폭발]]) == 200
		L_ダメージ補正 += 10
ENDIF
;---- EDIT 023 ADD START ---------------------------
;SONG OF DIVA発動中かつDARKNESS TRIGGER未使用(0)ㆍ強制解除後(2)は与ダメージが+20％
IF SKILLGAGE_H_GET(ARG, [[스킬:SONG OF DIVA]]) || SKILLGAGE_F_GET(ARG, [[스킬:SONG OF DIVA]])
	SIF SKILLGAGE_H_GET(ARG, [[스킬:DARKNESS TRIGGER]]) != 1
		L_ダメージ補正 += 20
ENDIF
;---- EDIT 023 ADD END ---------------------------
;---- EDIT 025 ADD START ---------------------------
;---- EDIT 031 MOD START --------------------------

;==============================
;種族特効処理　EDIT 39
;==============================
;各種種族への特効
;造魔特効はかなり存在価値が怪しいが……
;14.御霊、30.七星、33.ボス専用、39.リンク専用、40.ペルソナ専用、41.ペルソナ２、46.淫魔……への特効は作成しない
;基本的には１スキル１種族対応だが例外アリ
;ㆍ人間特効：「人間、狂人、超人」が対象（敵として出てくる人間キャラは、内部的には狂人であったり超人であったりするため）
;ㆍ半魔特効：「半魔、悪魔人」特効（悪魔人エネミーが少なすぎるし、わりと近いフレーバー持ってるので、まとめてもまあ構うまい、というところ）
;ㆍ魔人特効：「人間がモトなのか定かではない」ということで、人間特効には含まれない
;ㆍ英雄特効：「過去の人間のガワの悪魔」扱いということで、人間特効には含まれない
;==============================

SIF HAVE_SKILL(L_P,[[스킬:인간특효]])   && (ABL:L_T:종족 == 0 || ABL:L_T:종족 == 31 || ABL:L_T:종족 == 43)
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:지모신특효]]) && ABL:L_T:종족 == 1
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:여신특효]])   && ABL:L_T:종족 == 2
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:마왕특효]])   && ABL:L_T:종족 == 3
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:천사특효]])   && ABL:L_T:종족 == 4
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:요마특효]])   && ABL:L_T:종족 == 5
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:요정특효]])   && ABL:L_T:종족 == 6
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:요귀특효]])   && ABL:L_T:종족 == 7
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:용왕특효]])   && ABL:L_T:종족 == 8
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:마수특효]])   && ABL:L_T:종족 == 9
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:요조특효]])   && ABL:L_T:종족 == 10
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:외도특효]])   && ABL:L_T:종족 == 11
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:기계특효]])   && ABL:L_T:종족 == 12
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:정령특효]])   && ABL:L_T:종족 == 13
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:귀신특효]])   && ABL:L_T:종족 == 15
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:마신특효]])   && ABL:L_T:종족 == 16
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:사신특효]])   && ABL:L_T:종족 == 17
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:타천사특효]]) && ABL:L_T:종족 == 18
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:괴이특효]])   && ABL:L_T:종족 == 32
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:반마특효]])   && (ABL:L_T:종족 == 36 || ABL:L_T:종족 == 73)
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:마인특효]])   && ABL:L_T:종족 == 42
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:영웅특효]])   && ABL:L_T:종족 == 44
	L_ダメージ補正 += 20
SIF HAVE_SKILL(L_P,[[스킬:조마특효]])   && ABL:L_T:종족 == 45
	L_ダメージ補正 += 20

;==============================
;種族特効処理　おしまい
;==============================

;==============================
;FATE専用技に関する処理
;==============================

;◯魔力放出中は与ダメージに補正
	SIF SKILLGAGE_D_GET(ARG,PU_SKILLNUM_GET(ARG,"ノウブルㆍファンタズム")) > 0
		L_ダメージ補正 += 20

;◯サーヴァントクラス毎+特定属性の攻撃に補正
	;　セイバー　剣撃
	IF HAVE_PU_SKILL(ARG,"セイバー")
		SIF ARG:3 == GET_TYPE_NUM("검격")
			L_ダメージ補正 += 15
	;---- EDIT 025 ADD START ---------------------------
	;　ランサー　剣撃+打撃
	ELSEIF HAVE_PU_SKILL(ARG,"ランサー")
		SIF ARG:3 == GET_TYPE_NUM("검격") || ARG:3 == GET_TYPE_NUM("타격")
			L_ダメージ補正 += 10
	;---- EDIT 025 ADD END -----------------------------
	;　アーチャー　飛具
	ELSEIF HAVE_PU_SKILL(ARG,"アーチャー")
		SIF ARG:3 == GET_TYPE_NUM("비구")
			L_ダメージ補正 += 15
	;　ライダー　打撃
	ELSEIF HAVE_PU_SKILL(ARG,"ライダー")
		SIF ARG:3 == GET_TYPE_NUM("타격")
			L_ダメージ補正 += 15
	;　キャスター　魔法攻撃+、物理攻撃-(-補正は最終ダメージ側で処理)
	ELSEIF HAVE_PU_SKILL(ARG,"キャスター")
		SIF ARG:4 == 2
			L_ダメージ補正 += 20
	;　アヴェンジャー　攻撃全般に補正
	ELSEIF HAVE_PU_SKILL(ARG,"アヴェンジャー")
		L_ダメージ補正 += 10
	ENDIF
;---- EDIT 029 ADD START   ---------------------------
;◯相手がクラススキルを所持していた場合の処理
	;キャスター/アサシンの場合与ダメ増
	SIF HAVE_PU_SKILL(L_T,"キャスター") || HAVE_PU_SKILL(L_T,"アサシン")
		L_ダメージ補正 += 10
;◯バーサーカーの場合与ダメ、被ダメが大幅増
	SIF HAVE_PU_SKILL(L_P,"バーサーカー")
		L_ダメージ補正 += 20
	SIF HAVE_PU_SKILL(L_T,"バーサーカー")
		L_ダメージ補正 += 50

;◯ゲッシュ所持かつ、誓いを守れているかで補正が発生(;誓い（Fゲージ）0=プラス補正、-1=マイナス補正)
	IF HAVE_PU_SKILL(ARG,"ゲッシュ") && SKILLGAGE_F_GET(ARG,PU_SKILLNUM_GET(ARG,"ゲッシュ")) == -1
		L_ダメージ補正 -= 20
	ELSE
		L_ダメージ補正 += 20
	ENDIF
;---- EDIT 031 MOD END ----------------------------
; Hゲージの特定ビットがある時にクリティカルした場合、相性が「剣撃」、「電撃」、「重力」のいずれかであればダメージ+30%
; 適用した後はビットをクリア
IF L_CRT > 0 && (L_相性名 == "검격" && SKILLGAGE_H_GETBIT(L_P,(PU_SKILLNUM_GET(L_P,"∞黒餡子")),1) || L_相性名 == "전격" && SKILLGAGE_H_GETBIT(L_P,(PU_SKILLNUM_GET(L_P,"∞黒餡子")),2) || L_相性名 == "중력" && SKILLGAGE_H_GETBIT(L_P,(PU_SKILLNUM_GET(L_P,"∞黒餡子")),3))
	SELECTCASE L_相性名
		CASE "검격"
			CALL SKILLGAGE_H_SETBIT(L_P,(PU_SKILLNUM_GET(L_P,"∞黒餡子")),4)
			L_ダメージ補正 += 30
		CASE "전격"
			CALL SKILLGAGE_H_SETBIT(L_P,(PU_SKILLNUM_GET(L_P,"∞黒餡子")),5)
			L_ダメージ補正 += 30
		CASE "중력"
			CALL SKILLGAGE_H_SETBIT(L_P,(PU_SKILLNUM_GET(L_P,"∞黒餡子")),6)
			L_ダメージ補正 += 30
	ENDSELECT
ENDIF
; Dゲージが2より上であり、相性が「剣撃」、「電撃」、「重力」のいずれかであればダメージ+30%
SIF SKILLGAGE_D_GET(L_P,PU_SKILLNUM_GET(L_P,"刹那無影剣")) > 2 && (L_相性名 == "검격" || L_相性名 == "전격" || L_相性名 == "중력")
	L_ダメージ補正 += 30
;対象がセイバー認定された場合、ダメージ+50%
CALL AUTO_PU_SKILL_銀河流星剣(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;対象がセイバー顔認定された場合、ダメージ+150%
CALL AUTO_PU_SKILL_無銘勝利剣(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;対象がセイバー認定された場合、ダメージ+150%
;個別イベント経由済みだった場合、相手のLD属性がLight時にダメージ+50%
CALL AUTO_PU_SKILL_黒龍双剋勝利剣(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;---- EDIT 029 ADD END   ---------------------------
;○アンリマユは種族:인간への与ダメージ増
SIF HAVE_PU_SKILL(ARG,"この世全ての悪") && ABL:L_T:종족 == 0
	L_ダメージ補正 += 20
;○アンリマユは種族:광인への与ダメージ増
SIF HAVE_PU_SKILL(ARG,"この世全ての悪") && ABL:L_T:종족 == 31
	L_ダメージ補正 += 20
;○アンリマユは種族:초인への与ダメージ増
SIF HAVE_PU_SKILL(ARG,"この世全ての悪") && ABL:L_T:종족 == 43
	L_ダメージ補正 += 20
;○アンリマユはボスへの与ダメージ増
SIF HAVE_PU_SKILL(ARG,"最後の欠片") && CFLAG:L_T:보스플래그
	L_ダメージ補正 += 20
;==============================
;FATE専用技に関する処理ここまで
;==============================

;==============================
;魔人学園専用技に関する処理
;==============================
;◯【菩薩眼】の場合被ダメプラス
	SIF HAVE_PU_SKILL(ARG,"【菩薩眼】")
		TIMES L_DMG , 1.10
;◯【陽の黄龍の器】の場合与ダメアップ、被ダメマイナス
	SIF HAVE_PU_SKILL(ARG,"【陽の黄龍の器】")
		L_ダメージ補正 += 10
		TIMES L_DMG , 0.90
;◯【宿星：義星】の場合与ダメアップ
	SIF HAVE_PU_SKILL(ARG,"【宿星：義星】")
		L_ダメージ補正 += 5
;◯【宿星：白虎】の場合被ダメマイナス
	SIF HAVE_PU_SKILL(ARG,"【宿星：白虎】")
		TIMES L_DMG , 0.90
;◯【宿星：玄武】の場合被ダメマイナス
	SIF HAVE_PU_SKILL(ARG,"【宿星：玄武】")
		TIMES L_DMG , 0.90
;◯【宿星：青龍】の場合被ダメマイナス
	SIF HAVE_PU_SKILL(ARG,"【宿星：青龍】")
		TIMES L_DMG , 0.90
;◯【宿星：朱雀】の場合被ダメマイナス
	SIF HAVE_PU_SKILL(ARG,"【宿星：朱雀】")
		TIMES L_DMG , 0.90
;◯【宿星：悌星】の場合与えるダメアップ
	SIF HAVE_PU_SKILL(ARG,"【宿星：悌星】")
		L_ダメージ補正 += 5
;==============================
;魔人学園専用技に関する処理ここまで
;==============================

;属性ブースタ +25%
SIF HAVE_SKILL(L_P,2450 + ARG:3) && ARG:3 < 17
	L_ダメージ補正 += 25
;---- EDIT 026 ADD START   ---------------------------
;災厄の巨焔、ラグナロク（ＡＮ）、劫火の余燼の効果（効果値はERB側に記載）
L_ダメージ補正 += AUTO_PU_SKILL_災厄の巨焔(L_P,"ダメージ↑") + AUTO_PU_SKILL_災厄の巨焔(L_P,"ダメージ条件↑") + AUTO_PU_SKILL_ラグナロク（ＡＮ）(L_P,"ダメージ↑") + AUTO_PU_SKILL_劫火の余燼(L_P,"ダメージ↑")
;---- EDIT 026 ADD END   ---------------------------
;---- EDIT 038 ADD START ---------------------------
;戦術詠唱γ、キメラ起動中は強化を得る
CALL AUTO_PU_SKILL_戦術詠唱γ(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
CALL AUTO_PU_SKILL_キメラ(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;影霄ㆍ奔夜、影霄ㆍ絶影起動中は強化を得る
CALL AUTO_PU_SKILL_影霄ㆍ奔夜(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
CALL AUTO_PU_SKILL_影霄ㆍ絶影(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;同じ陣営のキャラが蒼き怒火を持っている場合、強化を得る
;専用スキル起動中の場合、効果倍増
CALL AUTO_PU_SKILL_蒼き怒火(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;---- EDIT 038 ADD END   ---------------------------
;気合で物理攻撃のみ+150%
IF CFLAG:L_P:기합플래그 && L_ダメージタイプ == 1 && !FLAG:총공격중 && !FLAG:카운터중
	L_ダメージ補正 += 150
	SIF CFLAG:L_P:기합플래그 == 2
		L_ダメージ補正 += 50
ENDIF
;---- EDIT 032 ADD START   ---------------------------
SIF CFLAG:L_P:타인기합플래그 == 1 && L_ダメージタイプ == 1 && !FLAG:총공격중 && !FLAG:카운터중
	L_ダメージ補正 += 50
;---- EDIT 032 ADD END   ---------------------------
;コンセントレイトで魔法攻撃のみ+150%
SIF CFLAG:L_P:집중플래그 && L_ダメージタイプ == 2 && !FLAG:카운터중
	L_ダメージ補正 += 150
;---- EDIT 032 ADD START   ---------------------------
SIF CFLAG:L_P:타인집중플래그 == 1 && L_ダメージタイプ == 2 && !FLAG:카운터중
	L_ダメージ補正 += 50
;---- EDIT 032 ADD END   ---------------------------
;---- EDIT 033 ADD START ---------------------------
CALL AUTO_PU_SKILL_変身ㆍ覚醒！／スタービーナスビリビリーム(L_P,"ダメージ↑",L_T)
L_ダメージ補正 += RESULT
;---- EDIT 033 ADD END   ---------------------------
;---- 東方MOD START   ---------------------------
;アナーキーバレットヘルㆍ魔法攻撃のみ+25%
SIF HAVE_SKILL(L_P,2947) && L_ダメージタイプ == 2 && NO:L_P == [[캐릭터:오키나]]
	L_ダメージ補正 += 25
;---- 東方MOD END   ---------------------------

L_DMG = L_DMG * L_ダメージ補正/100
	
;---- 素質によるダメージアップ
L_ダメージ補正 = 100
;異能者はダメージ上昇しない
IF !TALENT:L_P:이능자 && BATTLE_SETTING_IS_TALENT()
	;自身が達人持ちでダメージ上昇
	IF TALENT:L_P:달인 && IS_HUMAN(L_P) && !CFLAG:L_P:악마변신
		L_ダメージ補正 += 10
		SIF 순수달인체크(L_P)
			L_ダメージ補正 += 15
	ELSE
		;自身が素質持ちでダメージ上昇
		CALL 상성소질체크, L_P, ARG:3, 1
		SIF RESULT == 1
			L_ダメージ補正 += 15
	ENDIF
ENDIF
;人修羅ならダメージ上昇、戦闘時の素質影響設定 ON +30%、OFF +10%。
IF TALENT:L_P:인수라 && BATTLE_SETTING_IS_TALENT()
	L_ダメージ補正 += 30
ELSEIF TALENT:L_P:인수라
	L_ダメージ補正 += 10
ENDIF
;武器素質によるダメージアップ(銃を除く)
IF !FLAG:총공격중
	IF L_CRT > 0
		;フェンサー　二ノ型でクリティカルダメージアップ
		SIF L_武器素質P == 202
			L_ダメージ補正 += 11
		;剣術　二ノ型でクリティカルダメージアップ
		SIF L_武器素質P == 204
			L_ダメージ補正 += 8
	ENDIF
	IF L_相性値 > 100 && L_相性値 != 999
		;弓術　二ノ型で弱点ダメージアップ
		SIF L_武器素質P == 203
			L_ダメージ補正 += 11
		;剣術　二ノ型で弱点ダメージアップ
		SIF L_武器素質P == 204
			L_ダメージ補正 += 8
	ENDIF
	;槍、投具の二ノ型の場合後列からの攻撃が+3%
	SIF ((L_武器素質P == 205 && L_ダメージタイプ == 1) || (L_武器素質P == 208 && L_ダメージタイプ == 2)) && ((CFLAG:L_P:포지션 > 3 && CFLAG:L_P:포지션 < 7) || CFLAG:L_P:포지션 > 11)
		L_ダメージ補正 += 3
ENDIF
L_DMG = L_DMG * L_ダメージ補正/100

;---- EDIT 013 ADD END   ---------------------------
;ダメージダウン(全共通)
;---- EDIT 012 ADD START ---------------------------
;武器素質のダメージアップは↑に
;鞭術　二ノ型で魔法被ダメージダウン
SIF L_武器素質T == 207 && L_ダメージタイプ == 2
	TIMES L_DMG , 0.85
;マーシャルアーツ　二ノ型で物理被ダメージダウン
SIF L_武器素質T == 211 && L_ダメージタイプ == 1
	TIMES L_DMG , 0.85
;棒術　二ノ型で被ダメージダウン
SIF L_武器素質T == 210
	TIMES L_DMG , 0.91
;---- EDIT 012 ADD END   ---------------------------

;---- EDIT 015 ADD START ---------------------------
;クライマックスレヴュー展開中は被ダメージが0.8倍に
SIF SKILLGAGE_D_GET(L_T,3588)
	TIMES L_DMG , 0.80
;---- EDIT 015 ADD END ---------------------------
;---- EDIT 017 ADD START ---------------------------
;デビルトリガー中は被ダメージが0.65倍に
SIF SKILLGAGE_D_GET(L_T,[[스킬:데빌트리거]])
	TIMES L_DMG , 0.65
;---- EDIT 017 ADD END ---------------------------
;---- EDIT 023 ADD START ---------------------------
;SONG OF DIVA発動中かつDARKNESS TRIGGER未使用(0)ㆍ強制解除後(2)は被ダメージが0.8倍に
IF SKILLGAGE_H_GET(L_T, [[스킬:SONG OF DIVA]]) || SKILLGAGE_F_GET(L_T, [[스킬:SONG OF DIVA]])
	SIF SKILLGAGE_H_GET(L_T, [[스킬:DARKNESS TRIGGER]]) != 1
		TIMES L_DMG , 0.80
ENDIF
;---- EDIT 023 ADD END ---------------------------
;---- EDIT 025 ADD START ---------------------------
;■魔力放出中は被ダメージが0.8倍に
SIF SKILLGAGE_D_GET(L_T,PU_SKILLNUM_GET(L_T,"ノウブルㆍファンタズム"))
	TIMES L_DMG , 0.80
;---- EDIT 025 ADD END -----------------------------
;---- EDIT 029 ADD START   ---------------------------
;使用者の方がアサシンを所有していた場合、被ダメージが0.9倍に
SIF HAVE_PU_SKILL(L_P,"アサシン")
	TIMES L_DMG , 0.90
;---- EDIT 029 ADD END   ---------------------------
;---- EDIT 033 ADD START ---------------------------
;デンゲキコの変身中、被ダメージが0.8倍に
;小数点を返せないので100で割る式にする
CALL AUTO_PU_SKILL_変身ㆍ覚醒！／スタービーナスビリビリーム(L_P,"被ダメージ↓",L_T)
SIF RESULT != 0
	L_DMG = L_DMG * RESULT / 100
;---- EDIT 033 ADD END   ---------------------------
;---- EDIT 038 ADD START ---------------------------
;ソウルブースト起動中、自身が行う追撃の与えるダメージが低下
;小数点を返せないので100で割る式にする
CALL AUTO_PU_SKILL_ソウルブースト(L_P,"ダメージ↓",L_T)
SIF RESULT != 0
	L_DMG = L_DMG * RESULT / 100
;影霄ㆍ絶影起動中、魔法被ダメージが低下
;小数点を返せないので100で割る式にする
CALL AUTO_PU_SKILL_影霄ㆍ絶影(L_P,"魔法被ダメージ↓",L_T,L_ダメージタイプ)
SIF RESULT != 0
	L_DMG = L_DMG * RESULT / 100
;対象の陣営内に蒼き怒火を持つ者がいる場合、対象の陣営の被ダメージが低下
;小数点を返せないので100で割る式にする
CALL AUTO_PU_SKILL_蒼き怒火(L_P,"被ダメージ↓",L_T)
SIF RESULT != 0
	L_DMG = L_DMG * RESULT / 100
;---- EDIT 038 ADD END   ---------------------------

;ヘルズゲート処理
SIF EQUIP:MASTER:헬즈게이트 && GET_SUMMONER_MLV() && CFLAG:L_T:PT플래그 && !HAVE_SKILL(L_P, [[스킬:엑스트라원]] ) && !CFLAG:L_P:보스플래그 && (L_CRT || (L_相性値 > 100 && L_相性値 != 999)) && L_DMG > 0
	L_DMG *= 2

;---- EDIT 013 ADD ---------------------------
SIF !CFLAG:L_T:PT플래그 && CFLAG:L_T:피데미지제한 > 0 && L_DMG > CFLAG:L_T:피데미지제한
	L_DMG = CFLAG:L_T:피데미지제한

;---- EDIT 027 DEL START ---------------------------
;IF L_DMG >= BASE:L_T:ＨＰ && (HAVE_SKILL(L_T, [[스킬:불굴의투지]]) || (EQUIP:L_T:바ㆍ벨 && FLAG:벨신격파 & 8)) && CFLAG:L_T:이악물기플래그 == 0
;	PRINTFORM {L_DMG}ダメージ
;	CALL VAR_HP(L_T, -L_DMG, 2)
;	CFLAG:L_T:이악물기플래그 = 1
;ELSEIF  L_DMG >= BASE:L_T:ＨＰ && HAVE_SKILL(L_T, [[스킬:네버기브업]]) && CFLAG:L_T:이악물기플래그 == 0
;	PRINTFORM {L_DMG}ダメージ
;	CALL VAR_HP(L_T, -L_DMG, 5)
;	CFLAG:L_T:이악물기플래그 = 1
;;---- EDIT 023 ADD START ---------------------------
;;ダークネストリガー未使用(0)ㆍ強制解除後(2)でないと食いしばらない
;ELSEIF  L_DMG >= BASE:L_T:ＨＰ && HAVE_SKILL(L_T, [[스킬:SONG OF DIVA]]) && CFLAG:L_T:이악물기플래그 == 0 && SKILLGAGE_H_GET(L_T, [[스킬:DARKNESS TRIGGER]]) != 1
;	PRINTFORM {L_DMG}ダメージ
;	CALL VAR_HP(L_T, -L_DMG, 6)
;	CFLAG:L_T:이악물기플래그 = 1
;;---- EDIT 023 ADD END ---------------------------
;ELSEIF  L_DMG >= BASE:L_T:ＨＰ && HAVE_SKILL(L_T, [[스킬:이악물기]]) && CFLAG:L_T:이악물기플래그 == 0
;	PRINTFORM {L_DMG}ダメージ
;	CALL VAR_HP(L_T, -L_DMG, 1)
;	CFLAG:L_T:이악물기플래그 = 1
;ELSEIF L_DMG >= 0
;	PRINTFORM {L_DMG}ダメージ
;	CALL VAR_HP(L_T, -L_DMG, 0)
;---- EDIT 027 DEL END ---------------------------
;;---- EDIT 027 ADD ---------------------------
IF L_DMG >= 0
	PRINTFORM {L_DMG}데미지
	CALL VAR_HP(L_T, -L_DMG, -1)
ELSE
	PRINTFORM {-L_DMG}회복
	CALL VAR_HP(L_T, -L_DMG, 3)
	;わざわざスナッピーの為に何をしているんだ俺は
	CFLAG:L_T:데미지흡수량 -= L_DMG
ENDIF
;独善の禊処理
IF HAVE_SKILL(L_T,2467) && L_DMG > 0 && L_相性値 > 100 && L_相性値 != 999
	IF CFLAG:(ARG:1):PT플래그 < 1
		FOR LOCAL,0,6
			CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") = MIN(32, CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") + 4)
		NEXT
		PRINTFORM  & 全能力上昇
	ELSE
		CFLAG:(ARG:1):방어강화 = MIN(32, CFLAG:(ARG:1):방어강화 + 4)
		CFLAG:(ARG:1):마법효과강화 = MIN(32, CFLAG:(ARG:1):마법효과강화 + 4)
		PRINTFORM  & 방어、마법효과 상승
	ENDIF
ENDIF
;独깨달음処理
IF CFLAG:L_T:독각플래그 == 2 && L_相性値 > 100 && L_相性値 != 999 && L_DMG < 0
	IF CFLAG:(ARG:1):PT플래그 < 1
		FOR LOCAL,0,6
			CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") = MIN(32, CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") + 4)
		NEXT
		PRINTFORM  & 모든 능력 상승
	ENDIF
	IF CFLAG:(ARG:1):기합플래그 == 0 || CFLAG:(ARG:1):집중플래그 == 0
		PRINTL
		CFLAG:(ARG:1):기합플래그 = 1
		CFLAG:(ARG:1):집중플래그 = 1
		PRINTFORML 　　%조사처리(CALLNAME:(ARG:1), "는")% 씨익 웃었다…
	ENDIF
ENDIF
;吸収処理
IF L_DMG > 0 && L_T != L_P && L_ABS != 0
	L_吸収量 = L_DMG * L_ABS/100
	CFLAG:L_P:HP흡수량 += L_吸収量
ENDIF
;寝てたら起きる
SIF CFLAG:L_T:상태이상 == GET_STATE_NUM("SLEEP") && L_DMG > 0
	CFLAG:L_T:상태이상 = 0
	
;被弾者がBOMB状態かつ火炎ㆍ核熱相性のダメージを受けた場合
IF CFLAG:L_T:상태이상 == GET_STATE_NUM("BOMB") && L_DMG > 0 && ( L_相性名 == "화염" || L_相性名 == "핵열" )
	CFLAG:L_T:상태이상 = 0
	CFLAG:L_T:BOMB인화플래그 = 1
ENDIF
;-----------------------------
;- 終了
;-----------------------------
;VARSET RESULT
;RESULT:0=L_DMG
;RESULT:1=L_CRT

RETURN L_DMG, L_CRT

;=================================================
;   sub BTL_CALC_DAMAGE_COOP
;=================================================
;   BTL計算:COOP
;-------------------------------------------------
;   入力されたダメージ値を基に、ＣＯＯＰ可能かチェックをする
;-------------------------------------------------
; Input:
;  ARG:0				攻撃者
;  ARG:1				被攻撃者
;  ARG:2				ダメージ値
;  ARG:3				攻撃相性
;  ARG:4				ダメージタイプ(1:物理 2:魔法)
;  ARG:5				クリティカルフラグ(ビット1:相性 ビット2:物理)
;  ARG:6				威力
;-------------------------------------------------
@BTL_CALC_DAMAGE_COOP(ARG:0, ARG:1, ARG:2, ARG:3, ARG:4, ARG:5, ARG:6)
#DIM L_P
#DIM L_T
#DIM L_DMG
#DIMS L_相性名
#DIM L_相性値
#DIM L_物理貫通フラグ
#DIM L_ダメージタイプ
#DIM L_CRT
#DIM L_威力
#DIM 対象リスト , 16
#DIM 対象人数

;-----------------------------
;- 初期処理
;-----------------------------

L_P		= ARG:0
L_T		= ARG:1
L_DMG	= ARG:2
L_ダメージタイプ = ARG:4
L_CRT	=ARG:5
L_威力	=ARG:6

L_相性名	= %GET_TYPE(ARG:3)%
L_相性値	= MAXBASE:L_T:L_相性名


;-----------------------------
;- COOPチェック
;-----------------------------
;more系
;ヘルズゲート処理
SIF EQUIP:MASTER:헬즈게이트 && GET_SUMMONER_MLV() && CFLAG:L_P:PT플래그 < 1 && !HAVE_SKILL(L_P, [[스킬:엑스트라원]] ) && !CFLAG:L_P:보스플래그
	RETURN 0
;COOP or 1moreのフラグ立て
SIF L_相性値 > 100 && L_相性値 != 999
	SETBIT L_CRT, 1

;弱点を付かれ、防御しておらず、ダメージを受けており、瀕死になっていなければＣＯＯＰの対象に
;---- EDIT 014 START ---------------------------
IF L_DMG > 0 && CFLAG:L_T:방어플래그 == 0 && L_CRT
	IF CFLAG:L_P:PT플래그 > 0 && ((EQUIP:MASTER:ＣＯ－ＯＰ강화R && GET_SUMMONER_MLV() > 2) || CFLAG:L_T:상태이상 != GET_STATE_NUM("DYING"))
		;相性クリティカル(1ビット目)
		SIF GETBIT(L_CRT,1)
			CFLAG:L_T:ＣＯＯＰ플래그 += L_威力
		;物理クリティカル(2ビット目)
		SIF GETBIT(L_CRT,2)
			CFLAG:L_T:ＣＯＯＰ플래그 += L_威力/2
	ELSEIF CFLAG:L_P:PT플래그 != CFLAG:L_T:PT플래그
		CALL ONE_MORE_POINT_ADD,L_P,1
	ENDIF
ENDIF
;無効、吸収されたら１more値が下がる
IF CFLAG:L_P:PT플래그 != CFLAG:L_T:PT플래그 && L_DMG == 0
	CALL ONE_MORE_POINT_ADD,L_P,-1
ELSEIF CFLAG:L_P:PT플래그 != CFLAG:L_T:PT플래그 && L_DMG < 0
	CALL ONE_MORE_POINT_ADD,L_P,-2
ENDIF
;---- EDIT 014 END ---------------------------

IF EQUIP:MASTER:ＣＯ－ＯＰ강화R && GET_SUMMONER_MLV() > 2 && (BASE:L_T:ＨＰ < 1 || CFLAG:L_T:상태이상 == GET_STATE_NUM("DYING"))
	VARSET 対象リスト , 0
	対象人数 = 0
	FOR LOCAL , 7 , 17
		SIF POS(LOCAL) == -1
			CONTINUE
		SIF BASE:POS(LOCAL):ＨＰ < 1
			CONTINUE
		SIF GET_STATE(CFLAG:POS(LOCAL):상태이상) == "DYING"
			CONTINUE
		対象リスト:対象人数 = LOCAL
		対象人数 ++
	NEXT
	SIF 対象人数 > 0
		CFLAG:POS(対象リスト:(RAND:対象人数)):ＣＯＯＰ플래그 += CFLAG:L_T:ＣＯＯＰ플래그
ENDIF

;---- EDIT 014 ADD START ---------------------------

;=======================================================
;敵の1more値を加算する(マイナスだと減算)
;対象者	ARG
;減少値	ARG:1
;====================================================
@ONE_MORE_POINT_ADD,ARG,ARG:1
;味方だとしない
SIF CFLAG:ARG:PT플래그 > 0
	RETURN
;バニラ設定、エクストラワン持ちだと減算しない
SIF ARG:1 < 0 && (!BATTLE_SETTING_IS_1MORE() || HAVE_SKILL(ARG, [[스킬:엑스트라원]] ))
	RETURN
;ボスだと加算値2倍
SIF CFLAG:ARG:보스플래그 && ARG:1 > 0
	ARG:1 *= 2
;ボスだと減算値-1固定
SIF CFLAG:ARG:보스플래그 && ARG:1 < -1
	ARG:1 = -1
CFLAG:ARG:１more플래그 += ARG:1
;下がりすぎない、多すぎないようにする
IF 800 < CFLAG:ARG:１more플래그 && CFLAG:ARG:１more플래그 < 900
	CFLAG:ARG:１more플래그 = 800
ELSEIF 900 <= CFLAG:ARG:１more플래그 && CFLAG:ARG:１more플래그 < 950
	CFLAG:ARG:１more플래그 = 950
ENDIF
;---- EDIT 014 ADD END ---------------------------

;---- EDIT 024 ADD START ---------------------------
@RATE_DAMAGE,ARG,ARG:1,ARG:2,ARG:3,ARG:4,ARG:5,ARG:6,ARG:7,ARG:8
;=========================================
;割合ダメージ計算
;ARG:0 使用者
;ARG:1 対象キャラNo.
;ARG:2 威力
;ARG:3 相性
;ARG:4 CT率
;ARG:5 吸収率
;ARG:6 ダメージタイプ
;ARG:7 割合計算　0-現在HP　1-最大HP　-1-現在HP(不殺)　-2-最大HP(不殺)
;ARG:8 上限ダメージ(マイナスだと下限(敵使用時のみ対応))
;=========================================
#DIM L_P
#DIM L_T
#DIM L_貫通フラグ
#DIM L_ダメージタイプ
#DIM L_CRT
#DIM L_DMG
#DIMS L_相性名
#DIM L_相性値
#DIM L_クリ強化補正
#DIM L_DMGF

L_P = ARG:0
L_T = ARG:1
IF INRANGE(ARG:3,0,17)
	L_相性名 = %GET_TYPE(ARG:3)%
	L_相性値 = MAXBASE:L_T:L_相性名
ENDIF

L_ダメージタイプ = ARG:6
L_貫通フラグ = BTL_CHK_SKILL_관통(L_P,L_ダメージタイプ,L_相性値)
L_DMGF = 0
L_CRT = 0


CALL RECEIVE_SET,ARG:1,ARG:3,ARG:6
SIF !FLAG:카운터중
	CFLAG:(ARG:1):회피실패 = 1

IF INRANGE(ARG:3,0,17) && (BTL_CALC_DAMAGE_BLOCK(ARG:0, ARG:1, ARG:3, L_ダメージタイプ))
	CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, 0, 1
	PRINT BLOCK
	RETURN 0
ENDIF

;味方使用時は威力900まで
SIF CFLAG:ARG:PT플래그 > 0 && ARG:2 > 900
	ARG:2 = 900

;割合ダメージは威力の1/10％
L_DMG = (ARG:7 == 0 || ARG:7 == -1 ? BASE:(ARG:1):ＨＰ # MAXBASE:(ARG:1):ＨＰ) * ARG:2 / 1000

;ボスの場合強制的に現在ダメージ、ダメージ激減
IF CFLAG:L_T:보스플래그 > 0
	L_DMG = BASE:(ARG:1):ＨＰ * ARG:2 / 1000
	L_DMG /= 4 + CFLAG:L_T:보스플래그
ENDIF
	
;上限、下限ダメージ調整
;味方の場合上限ダメージを設定してない場合、上限ダメージは威力の数字
IF ARG:8 > 0 && !(CFLAG:L_P:보스플래그 > 0 && CFLAG:ARG:PT플래그 < 1)
	L_DMG = MIN(ARG:8,L_DMG)
ELSEIF ARG:8 < 0 && CFLAG:ARG:PT플래그 < 1
	L_DMG = MAX(-ARG:8,L_DMG)
ELSEIF CFLAG:ARG:PT플래그 > 0
	L_DMG = MIN(ARG:2,L_DMG)
ENDIF

;- 物理ダメージタイプ
IF ARG:6 == 1
	SIF !CFLAG:L_P:PT플래그
		L_DMG = L_DMG * (CFLAG:L_T:물리피데미지보정 +100) / 100
;- 魔法ダメージタイプ
ELSEIF ARG:6 == 2
	SIF !CFLAG:L_P:PT플래그
		L_DMG = L_DMG * (CFLAG:L_T:마법피데미지보정 +100) / 100
ENDIF
SIF INRANGE(ARG:3,0,17) && !CFLAG:L_T:PT플래그
	L_DMG = L_DMG * (CFLAG:L_T:(L_相性名 + "피데미지보정") +100) / 100
IF INRANGE(ARG:3,0,17)
	;ドレイン状態
	IF CFLAG:L_T:(L_相性名 + "웨이트") == 3 
		L_DMG *= -50
	;物理ダメージタイプで貫通
	ELSEIF L_貫通フラグ && INRANGE(L_相性値,0,99)
		L_DMG *= 100
		L_DMGF = 1
	;ガードキル
	ELSEIF CFLAG:L_T:(L_相性名 + "가드킬") && (L_相性値 < 100 || L_相性値 == 999)
		L_DMG *= 100
		L_DMGF = 1
	ELSE
		L_DMG *= L_相性値
		SIF L_相性値 > 0 && L_相性値 != 999
			L_DMGF = 1
	ENDIF
	L_DMG /= 100
ELSE
	L_DMGF = 1
ENDIF
;- 割合ダメージ補正
SIF CFLAG:L_T:PT플래그 < 0
	L_DMG = L_DMG * (CFLAG:L_T:비율데미지보정 +100) / 100

IF NO:L_T == [[캐릭터:벨ㆍ데르]]
	CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, 0, 1
	PRINT BLOCK
	RETURN 0
ENDIF
SIF L_DMGF && L_DMG == 0
	L_DMG = 1

;ボスの場合使用者のLV*10が強制上限ダメージ
SIF CFLAG:L_T:보스플래그 > 0 && L_DMG > 0
	L_DMG = MIN(MAXBASE:L_P:LV*10,L_DMG)

;自分か相手がプリンキピアを持っているのならCRITICALはキャンセルされる
IF HAVE_SKILL(L_P, [[스킬:프린키피아]]) || HAVE_SKILL(L_T, [[스킬:프린키피아]]) || (!CFLAG:L_T:PT플래그 && CFLAG:L_T:크리티컬무효플래그)

;物理ダメージかつ攻撃側に会心確定フラグが立っている場合強制必殺
;　鬼　の　よ　う　に　強　力　な　の　で　常に使用可能なスキルには搭載しない事。
ELSEIF CFLAG:L_P:회심확정플래그 && (L_ダメージタイプ == 1) && CFLAG:ARG:PT플래그 < 1
		PRINTFORM 《CRITICAL》 
		SETBIT L_CRT, 2
;- 物理ダメージタイプ
ELSEIF (L_ダメージタイプ == 1) && CFLAG:ARG:PT플래그 < 1
	;物理で敵のみクリティカル発生
	L_クリ強化補正 = 100
	;---- EDIT 040 ADD START 会心率強化と切り落としの必中を独立に---------------------------	
	;L_クリ強化補正 += (!FLAG:총공격중 && !FLAG:카운터중 && CFLAG:L_P:베어내기플래그) * 20
	L_クリ強化補正 += (!FLAG:총공격중 && !FLAG:카운터중 && CFLAG:L_P:회심률강화플래그) * 50
	;---- EDIT 040 ADD END---------------------------	

	;攻撃側が「与クリティカル率減少」（粗雑）を持っていたらクリティカル率が減少
	SIF HAVE_SKILL(L_P,[[스킬:조잡]])
		L_クリ強化補正 = MAX(1, L_クリ強化補正 - 20)

	;受け手側が「被クリティカル率上昇」（慢心）を持っていたらクリティカル率増大
	SIF HAVE_SKILL(L_T,[[스킬:자만심]])
		L_クリ強化補正 += 20

	L_クリ強化補正 += CFLAG:L_P:크리티컬보정
	L_クリ強化補正 *= (10 + MAXBASE:L_P:운)
	L_クリ強化補正 /= (10 + MAXBASE:L_T:운) 
	L_クリ強化補正 *= (CFLAG:L_P:크리티컬강화+8)
	L_クリ強化補正 /= 8 
	{
		L_クリ強化補正 *= 
			(HAVE_SKILL(L_P,[[스킬:어드바이스]]) > 0)
			+ (HAVE_SKILL(L_P,[[스킬:서드아이]]) > 0)
			+ (HAVE_SKILL(L_P,PU_SKILLNUM_GET(L_P,"ランサー")) > 0) 
			+ (HAVE_PU_SKILL(L_P,"アサシン") > 0)
			+ (HAVE_PU_SKILL(L_P,"直感") > 0)
			+ (HAVE_PU_SKILL(L_P,"セイバーの星") > 0)
			+ ((HAVE_PU_SKILL(L_P,"刹那無影剣") > 0) * 2)
			+ (HAVE_PU_SKILL(L_P,"病弱") > 0)
			+ 1
	}
	{
		L_クリ強化補正 /= 
			(HAVE_SKILL(L_T,[[스킬:코칭]]) > 0) 
			+ (HAVE_SKILL(L_T,[[스킬:에어하이크]]) > 0) 
			+ (HAVE_SKILL(L_T,[[스킬:롤링블레이즈]]) > 0)
			+ (HAVE_SKILL(L_T,[[스킬:서드아이]]) > 0) 
			+ (HAVE_SKILL(L_T,PU_SKILLNUM_GET(L_T,"ランサー")) > 0) 
			+ (HAVE_PU_SKILL(L_T,"直感") > 0) 
			+ (HAVE_PU_SKILL(L_T,"セイバーの星") > 0) 
			+ (HAVE_PU_SKILL(L_T,"刹那無影剣") > 0)
			+ 1
	}

;---- EDIT 014 ADD END ---------------------------
	
	IF RAND:100 < ARG:5 * L_クリ強化補正 / 100
		PRINTFORM 《CRITICAL》 
		SETBIT L_CRT, 2
	ELSEIF (HAVE_SKILL(L_P, [[스킬:황천의회심]]) && FLAG:월령 == 8) || (HAVE_SKILL(L_P, [[스킬:정천의회심]]) && FLAG:월령 == 0)
		PRINTFORM 《CRITICAL》 
		SETBIT L_CRT, 2
	ELSE
		SELECTCASE GET_STATE(CFLAG:L_T:상태이상)
			CASE "SLEEP","SHOCK","FREEZE"
				PRINTFORM 《CRITICAL》 
				SETBIT L_CRT, 2
		ENDSELECT
	ENDIF
ENDIF

SIF !CFLAG:L_T:PT플래그 && CFLAG:L_T:피데미지제한 > 0 && L_DMG > CFLAG:L_T:피데미지제한
	L_DMG = CFLAG:L_T:피데미지제한
IF L_DMG >= 0 && L_DMGF
	SIF ARG:7 < 0 && BASE:(ARG:1):ＨＰ <= L_DMG
		L_DMG = BASE:(ARG:1):ＨＰ - 1
	PRINTFORM {L_DMG}데미지
ELSEIF L_DMG < 0
	PRINTFORM {-L_DMG}회복
ENDIF
CALL VAR_HP(L_T, -L_DMG)

;独善の禊処理
IF INRANGE(ARG:3,0,17) && HAVE_SKILL(L_T,2467) && L_DMG > 0 && L_相性値 > 100 && L_相性値 != 999
	IF CFLAG:(ARG:1):PT플래그 < 1
		FOR LOCAL,0,6
			CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") = MIN(32, CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") + 4)
		NEXT
		PRINTFORM  & 모든 능력 상승
	ELSE
		CFLAG:(ARG:1):방어강화 = MIN(32, CFLAG:(ARG:1):방어강화 + 4)
		CFLAG:(ARG:1):마법효과강화 = MIN(32, CFLAG:(ARG:1):마법효과강화 + 4)
		PRINTFORM  & 방어、마법효과 상승
	ENDIF
ENDIF
;独覚処理
IF INRANGE(ARG:3,0,17) && CFLAG:L_T:독각플래그 == 2 && L_相性値 > 100 && L_相性値 != 999 && L_DMG < 0
	IF CFLAG:(ARG:1):PT플래그 < 1
		FOR LOCAL,0,6
			CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") = MIN(32, CFLAG:(ARG:1):(GET_BATTLESTATUS(LOCAL) + "강화") + 4)
		NEXT
		PRINTFORM  & 모든 능력 상승
	ENDIF
	IF CFLAG:(ARG:1):기합플래그 == 0 || CFLAG:(ARG:1):집중플래그 == 0
		PRINTL
		CFLAG:(ARG:1):기합플래그 = 1
		CFLAG:(ARG:1):집중플래그 = 1
		PRINTFORML 　　%CALLNAME:(ARG:1)%はニヤリと笑った…
	ENDIF
ENDIF
;吸収処理
IF L_DMG > 0 && L_T != L_P && ARG:5 != 0
	CFLAG:L_P:HP흡수량 += L_DMG * ARG:5/100
ENDIF
;寝てたら起きる
SIF CFLAG:L_T:상태이상 == GET_STATE_NUM("SLEEP") && L_DMG > 0
	CFLAG:L_T:상태이상 = 0
	
;被弾者がBOMB状態かつ火炎ㆍ核熱相性のダメージを受けた場合
IF INRANGE(ARG:3,0,17) && CFLAG:L_T:상태이상 == GET_STATE_NUM("BOMB") && L_DMG > 0 && ( L_相性名 == "화염" || L_相性名 == "핵열" )
	CFLAG:L_T:상태이상 = 0
	CFLAG:L_T:BOMB인화플래그 = 1
ENDIF

CALL RECEIVE_SET,ARG:1,ARG:3,L_ダメージタイプ,L_DMG,L_CRT

;口上用にフラグ保存
CALL BATTLE_EVENT_ATTACK, ARG , ARG:1, L_DMG, 1

;敵のみ1MOREフラグ
SIF CFLAG:ARG:PT플래그 < 1 && !FLAG:카운터중
	CALL BTL_CALC_DAMAGE_COOP(ARG:0, ARG:1, L_DMG, ARG:3, L_ダメージタイプ, L_CRT, ARG:2)
	
RETURN L_DMGF
;---- EDIT 024 ADD END ---------------------------